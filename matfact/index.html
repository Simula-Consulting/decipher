
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-8.5.9">
    
    
      
        <title>MatFact - Decipher</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.20d9efc8.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.08040f6c.min.css">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#matfact" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Decipher" class="md-header__button md-logo" aria-label="Decipher" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Decipher
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              MatFact
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Decipher" class="md-nav__button md-logo" aria-label="Decipher" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Decipher
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../usage/" class="md-nav__link">
        Usage
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Reference" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          MatFact
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        MatFact
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#matfact.model.matfact" class="md-nav__link">
    matfact
  </a>
  
    <nav class="md-nav" aria-label="matfact">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#matfact.model.matfact.ArgmaxPredictor" class="md-nav__link">
    ArgmaxPredictor
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matfact.model.matfact.ClassificationTreePredictor" class="md-nav__link">
    ClassificationTreePredictor
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matfact.model.matfact.MatFact" class="md-nav__link">
    MatFact
  </a>
  
    <nav class="md-nav" aria-label="MatFact">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#matfact.model.matfact.MatFact.fit" class="md-nav__link">
    fit()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matfact.model.matfact.Predictor" class="md-nav__link">
    Predictor
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matfact.model.matfact.ProbabilityEstimator" class="md-nav__link">
    ProbabilityEstimator
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#matfact.model.config" class="md-nav__link">
    config
  </a>
  
    <nav class="md-nav" aria-label="config">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#matfact.model.config.ModelConfig" class="md-nav__link">
    ModelConfig
  </a>
  
    <nav class="md-nav" aria-label="ModelConfig">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#matfact.model.config.ModelConfig.difference_matrix_getter" class="md-nav__link">
    difference_matrix_getter
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matfact.model.config.ModelConfig.initial_basic_profiles_getter" class="md-nav__link">
    initial_basic_profiles_getter
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matfact.model.config.ModelConfig.minimal_value_matrix_getter" class="md-nav__link">
    minimal_value_matrix_getter
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matfact.model.config.ModelConfig.weight_matrix_getter" class="md-nav__link">
    weight_matrix_getter
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matfact.model.config.ModelConfig.get_short_model_name" class="md-nav__link">
    get_short_model_name()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#matfact.model" class="md-nav__link">
    model
  </a>
  
    <nav class="md-nav" aria-label="model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#matfact.model.train_and_log" class="md-nav__link">
    train_and_log()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#matfact.model.factorization" class="md-nav__link">
    factorization
  </a>
  
    <nav class="md-nav" aria-label="factorization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#matfact.model.factorization.BaseMF" class="md-nav__link">
    BaseMF
  </a>
  
    <nav class="md-nav" aria-label="BaseMF">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#matfact.model.factorization.factorizers.mfbase.BaseMF.matrix_completion" class="md-nav__link">
    matrix_completion()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matfact.model.factorization.factorizers.mfbase.BaseMF.predict_probability" class="md-nav__link">
    predict_probability()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matfact.model.factorization.CMF" class="md-nav__link">
    CMF
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matfact.model.factorization.SCMF" class="md-nav__link">
    SCMF
  </a>
  
    <nav class="md-nav" aria-label="SCMF">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#matfact.model.factorization.factorizers.scmf.SCMF.V" class="md-nav__link">
    V
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matfact.model.factorization.WCMF" class="md-nav__link">
    WCMF
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#matfact.model.factorization.convergence" class="md-nav__link">
    matfact.model.factorization.convergence
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#matfact.model.factorization.convergence.ConvergenceMonitor" class="md-nav__link">
    ConvergenceMonitor
  </a>
  
    <nav class="md-nav" aria-label="ConvergenceMonitor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#matfact.model.factorization.convergence.ConvergenceMonitor.__call__" class="md-nav__link">
    __call__()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#matfact.model.logging" class="md-nav__link">
    logging
  </a>
  
    <nav class="md-nav" aria-label="logging">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#matfact.model.logging.MLFlowBatchLogger" class="md-nav__link">
    MLFlowBatchLogger
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matfact.model.logging.MLFlowLogger" class="md-nav__link">
    MLFlowLogger
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matfact.model.logging.MLFlowLoggerArtifact" class="md-nav__link">
    MLFlowLoggerArtifact
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matfact.model.logging.MLFlowLoggerDiagnostic" class="md-nav__link">
    MLFlowLoggerDiagnostic
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matfact.model.logging.batch_mlflow_logger" class="md-nav__link">
    batch_mlflow_logger()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matfact.model.logging.mlflow_logger" class="md-nav__link">
    mlflow_logger()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#matfact.data_generation.Dataset" class="md-nav__link">
    Dataset
  </a>
  
    <nav class="md-nav" aria-label="Dataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#matfact.data_generation.dataset.Dataset.from_file" class="md-nav__link">
    from_file()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matfact.data_generation.dataset.Dataset.generate" class="md-nav__link">
    generate()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matfact.data_generation.dataset.Dataset.get_X_M" class="md-nav__link">
    get_X_M()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matfact.data_generation.dataset.Dataset.get_split_X_M" class="md-nav__link">
    get_split_X_M()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matfact.data_generation.dataset.Dataset.prefixed_metadata" class="md-nav__link">
    prefixed_metadata()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matfact.data_generation.dataset.Dataset.save" class="md-nav__link">
    save()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#matfact.model.predict.dataset_utils" class="md-nav__link">
    matfact.model.predict.dataset_utils
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#matfact.model.predict.dataset_utils.prediction_data" class="md-nav__link">
    prediction_data()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#matfact.model.predict.classification_tree" class="md-nav__link">
    matfact.model.predict.classification_tree
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#matfact.model.predict.classification_tree.ClassificationTree" class="md-nav__link">
    ClassificationTree
  </a>
  
    <nav class="md-nav" aria-label="ClassificationTree">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#matfact.model.predict.classification_tree.ClassificationTree.fit" class="md-nav__link">
    fit()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matfact.model.predict.classification_tree.ClassificationTree.predict" class="md-nav__link">
    predict()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#matfact.model.predict.classification_tree.estimate_probability_thresholds" class="md-nav__link">
    estimate_probability_thresholds()
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../hmm/" class="md-nav__link">
        HMM
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Examples
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Examples" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Examples
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../examples/example/" class="md-nav__link">
        Simple example
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../examples/example_class_based/" class="md-nav__link">
        Example usage of class based Matfact API.
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../examples/example_hyperparamsearch/" class="md-nav__link">
        Example of an hyperparameter search.
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../examples/example_train_and_log/" class="md-nav__link">
        Example using `train_and_log` for simpler workflow.
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#matfact.model.matfact" class="md-nav__link">
    matfact
  </a>
  
    <nav class="md-nav" aria-label="matfact">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#matfact.model.matfact.ArgmaxPredictor" class="md-nav__link">
    ArgmaxPredictor
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matfact.model.matfact.ClassificationTreePredictor" class="md-nav__link">
    ClassificationTreePredictor
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matfact.model.matfact.MatFact" class="md-nav__link">
    MatFact
  </a>
  
    <nav class="md-nav" aria-label="MatFact">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#matfact.model.matfact.MatFact.fit" class="md-nav__link">
    fit()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matfact.model.matfact.Predictor" class="md-nav__link">
    Predictor
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matfact.model.matfact.ProbabilityEstimator" class="md-nav__link">
    ProbabilityEstimator
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#matfact.model.config" class="md-nav__link">
    config
  </a>
  
    <nav class="md-nav" aria-label="config">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#matfact.model.config.ModelConfig" class="md-nav__link">
    ModelConfig
  </a>
  
    <nav class="md-nav" aria-label="ModelConfig">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#matfact.model.config.ModelConfig.difference_matrix_getter" class="md-nav__link">
    difference_matrix_getter
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matfact.model.config.ModelConfig.initial_basic_profiles_getter" class="md-nav__link">
    initial_basic_profiles_getter
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matfact.model.config.ModelConfig.minimal_value_matrix_getter" class="md-nav__link">
    minimal_value_matrix_getter
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matfact.model.config.ModelConfig.weight_matrix_getter" class="md-nav__link">
    weight_matrix_getter
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matfact.model.config.ModelConfig.get_short_model_name" class="md-nav__link">
    get_short_model_name()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#matfact.model" class="md-nav__link">
    model
  </a>
  
    <nav class="md-nav" aria-label="model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#matfact.model.train_and_log" class="md-nav__link">
    train_and_log()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#matfact.model.factorization" class="md-nav__link">
    factorization
  </a>
  
    <nav class="md-nav" aria-label="factorization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#matfact.model.factorization.BaseMF" class="md-nav__link">
    BaseMF
  </a>
  
    <nav class="md-nav" aria-label="BaseMF">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#matfact.model.factorization.factorizers.mfbase.BaseMF.matrix_completion" class="md-nav__link">
    matrix_completion()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matfact.model.factorization.factorizers.mfbase.BaseMF.predict_probability" class="md-nav__link">
    predict_probability()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matfact.model.factorization.CMF" class="md-nav__link">
    CMF
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matfact.model.factorization.SCMF" class="md-nav__link">
    SCMF
  </a>
  
    <nav class="md-nav" aria-label="SCMF">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#matfact.model.factorization.factorizers.scmf.SCMF.V" class="md-nav__link">
    V
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matfact.model.factorization.WCMF" class="md-nav__link">
    WCMF
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#matfact.model.factorization.convergence" class="md-nav__link">
    matfact.model.factorization.convergence
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#matfact.model.factorization.convergence.ConvergenceMonitor" class="md-nav__link">
    ConvergenceMonitor
  </a>
  
    <nav class="md-nav" aria-label="ConvergenceMonitor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#matfact.model.factorization.convergence.ConvergenceMonitor.__call__" class="md-nav__link">
    __call__()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#matfact.model.logging" class="md-nav__link">
    logging
  </a>
  
    <nav class="md-nav" aria-label="logging">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#matfact.model.logging.MLFlowBatchLogger" class="md-nav__link">
    MLFlowBatchLogger
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matfact.model.logging.MLFlowLogger" class="md-nav__link">
    MLFlowLogger
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matfact.model.logging.MLFlowLoggerArtifact" class="md-nav__link">
    MLFlowLoggerArtifact
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matfact.model.logging.MLFlowLoggerDiagnostic" class="md-nav__link">
    MLFlowLoggerDiagnostic
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matfact.model.logging.batch_mlflow_logger" class="md-nav__link">
    batch_mlflow_logger()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matfact.model.logging.mlflow_logger" class="md-nav__link">
    mlflow_logger()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#matfact.data_generation.Dataset" class="md-nav__link">
    Dataset
  </a>
  
    <nav class="md-nav" aria-label="Dataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#matfact.data_generation.dataset.Dataset.from_file" class="md-nav__link">
    from_file()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matfact.data_generation.dataset.Dataset.generate" class="md-nav__link">
    generate()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matfact.data_generation.dataset.Dataset.get_X_M" class="md-nav__link">
    get_X_M()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matfact.data_generation.dataset.Dataset.get_split_X_M" class="md-nav__link">
    get_split_X_M()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matfact.data_generation.dataset.Dataset.prefixed_metadata" class="md-nav__link">
    prefixed_metadata()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matfact.data_generation.dataset.Dataset.save" class="md-nav__link">
    save()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#matfact.model.predict.dataset_utils" class="md-nav__link">
    matfact.model.predict.dataset_utils
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#matfact.model.predict.dataset_utils.prediction_data" class="md-nav__link">
    prediction_data()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#matfact.model.predict.classification_tree" class="md-nav__link">
    matfact.model.predict.classification_tree
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#matfact.model.predict.classification_tree.ClassificationTree" class="md-nav__link">
    ClassificationTree
  </a>
  
    <nav class="md-nav" aria-label="ClassificationTree">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#matfact.model.predict.classification_tree.ClassificationTree.fit" class="md-nav__link">
    fit()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matfact.model.predict.classification_tree.ClassificationTree.predict" class="md-nav__link">
    predict()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#matfact.model.predict.classification_tree.estimate_probability_thresholds" class="md-nav__link">
    estimate_probability_thresholds()
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="matfact">MatFact</h1>
<p>Matrix Factorization with temporal regularization.</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">matfact.model</span> <span class="kn">import</span> <span class="n">train_and_log</span>
<span class="kn">from</span> <span class="nn">matfact.data_generation</span> <span class="kn">import</span> <span class="n">Dataset</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">generate</span><span class="p">()</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get_split_X_M</span><span class="p">()</span>

<span class="n">train_and_log</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">)</span>
</code></pre></div>
</div>


<div class="doc doc-object doc-module">



<h2 id="matfact.model.matfact" class="doc doc-heading">
          <code>matfact.model.matfact</code>


</h2>

  <div class="doc doc-contents first">

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h3 id="matfact.model.matfact.ArgmaxPredictor" class="doc doc-heading">
        <code>ArgmaxPredictor</code>


</h3>


  <div class="doc doc-contents ">

  
      <p>Maximum probability predictor.</p>


        <details class="quote">
          <summary>Source code in <code>matfact/model/matfact.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">ArgmaxPredictor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Maximum probability predictor.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matfact</span><span class="p">,</span> <span class="n">observation_matrix</span><span class="p">):</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probabilities</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">probabilities</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="matfact.model.matfact.ClassificationTreePredictor" class="doc doc-heading">
        <code>ClassificationTreePredictor</code>


</h3>


  <div class="doc doc-contents ">

  
      <p>Threshold based predictor.</p>
<p>Predict class from probabilities using thresholds biasing towards more rare states.
See <a class="autorefs autorefs-internal" href="#matfact.model.predict.classification_tree">matfact.model.predict.classification_tree</a> for details.</p>


        <details class="quote">
          <summary>Source code in <code>matfact/model/matfact.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">ClassificationTreePredictor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Threshold based predictor.</span>

<span class="sd">    Predict class from probabilities using thresholds biasing towards more rare states.</span>
<span class="sd">    See [matfact.model.predict.classification_tree][] for details.&quot;&quot;&quot;</span>

    <span class="n">_classification_tree</span><span class="p">:</span> <span class="n">ClassificationTree</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matfact</span><span class="p">,</span> <span class="n">observation_matrix</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">matfact</span> <span class="o">=</span> <span class="n">matfact</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_classification_tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_estimate_classification_tree</span><span class="p">(</span>
            <span class="n">observation_matrix</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probabilities</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_classification_tree</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">probabilities</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_estimate_classification_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observation_matrix</span><span class="p">):</span>
        <span class="n">observation_matrix_masked</span><span class="p">,</span> <span class="n">time_points</span><span class="p">,</span> <span class="n">true_values</span> <span class="o">=</span> <span class="n">prediction_data</span><span class="p">(</span>
            <span class="n">observation_matrix</span>
        <span class="p">)</span>
        <span class="n">probabilities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matfact</span><span class="o">.</span><span class="n">predict_probabilities</span><span class="p">(</span>
            <span class="n">observation_matrix_masked</span><span class="p">,</span> <span class="n">time_points</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">estimate_probability_thresholds</span><span class="p">(</span><span class="n">true_values</span><span class="p">,</span> <span class="n">probabilities</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="matfact.model.matfact.MatFact" class="doc doc-heading">
        <code>MatFact</code>


</h3>


  <div class="doc doc-contents ">

  
      <p>SKLearn like class for MatFact.</p>


        <details class="quote">
          <summary>Source code in <code>matfact/model/matfact.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">MatFact</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;SKLearn like class for MatFact.&quot;&quot;&quot;</span>

    <span class="n">_factorizer</span><span class="p">:</span> <span class="n">BaseMF</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span>
        <span class="n">predictor</span><span class="p">:</span> <span class="n">Predictor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">probability_estimator</span><span class="p">:</span> <span class="n">ProbabilityEstimator</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_factory</span><span class="o">=</span><span class="n">_model_factory</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_predictor</span> <span class="o">=</span> <span class="n">predictor</span> <span class="ow">or</span> <span class="n">ClassificationTreePredictor</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_probability_estimator</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">probability_estimator</span> <span class="ow">or</span> <span class="n">DefaultProbabilityEstimator</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model_factory</span> <span class="o">=</span> <span class="n">model_factory</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observation_matrix</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fit the model.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_factorizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_factory</span><span class="p">(</span><span class="n">observation_matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_factorizer</span><span class="o">.</span><span class="n">matrix_completion</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observation_matrix</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observation_matrix</span><span class="p">,</span> <span class="n">time_points</span><span class="p">):</span>
        <span class="n">probabilities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_probabilities</span><span class="p">(</span><span class="n">observation_matrix</span><span class="p">,</span> <span class="n">time_points</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">probabilities</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">predict_probabilities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observation_matrix</span><span class="p">,</span> <span class="n">time_points</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_is_fitted</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_probability_estimator</span><span class="o">.</span><span class="n">predict_probability</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">observation_matrix</span><span class="p">,</span> <span class="n">time_points</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_factorizer&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">NotFittedException</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h4 id="matfact.model.matfact.MatFact.fit" class="doc doc-heading">
<code class="highlight language-python"><span class="n">fit</span><span class="p">(</span><span class="n">observation_matrix</span><span class="p">)</span></code>

</h4>


  <div class="doc doc-contents ">
  
      <p>Fit the model.</p>

      <details class="quote">
        <summary>Source code in <code>matfact/model/matfact.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observation_matrix</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fit the model.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_factorizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_factory</span><span class="p">(</span><span class="n">observation_matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_factorizer</span><span class="o">.</span><span class="n">matrix_completion</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observation_matrix</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="matfact.model.matfact.Predictor" class="doc doc-heading">
        <code>Predictor</code>


</h3>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="typing.Protocol">Protocol</span></code></p>

  
      <p>Predictor takes probabilities and gives a prediction.</p>


        <details class="quote">
          <summary>Source code in <code>matfact/model/matfact.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Predictor</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Predictor takes probabilities and gives a prediction.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matfact</span><span class="p">,</span> <span class="n">observation_matrix</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probabilities</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
        <span class="o">...</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="matfact.model.matfact.ProbabilityEstimator" class="doc doc-heading">
        <code>ProbabilityEstimator</code>


</h3>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="typing.Protocol">Protocol</span></code></p>

  
      <p>Return probabilities for the different states.</p>


        <details class="quote">
          <summary>Source code in <code>matfact/model/matfact.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">ProbabilityEstimator</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return probabilities for the different states.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">predict_probability</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">matfact</span><span class="p">,</span> <span class="n">observation_matrix</span><span class="p">,</span> <span class="n">time_points</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
        <span class="o">...</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>




  </div>

  </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="matfact.model.config" class="doc doc-heading">
          <code>matfact.model.config</code>


</h2>

  <div class="doc doc-contents first">

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h3 id="matfact.model.config.ModelConfig" class="doc doc-heading">
        <code>ModelConfig</code>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">

  
      <p>Configuration class for the MatFact model.</p>


        <details class="quote">
          <summary>Source code in <code>matfact/model/config.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ModelConfig</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Configuration class for the MatFact model.&quot;&quot;&quot;</span>

    <span class="n">shift_budget</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

    <span class="n">lambda1</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">lambda2</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">lambda3</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="n">rank</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span>

    <span class="n">iter_U</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">iter_V</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="n">learning_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.001</span>
    <span class="n">number_of_states</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">default_number_of_states</span>

    <span class="n">difference_matrix_getter</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">],</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span>
    <span class="sd">&quot;&quot;&quot;Return the difference matrix to use for regularization.</span>

<span class="sd">    Takes in the time dimension size of the observation matrix.&quot;&quot;&quot;</span>
    <span class="n">weight_matrix_getter</span><span class="p">:</span> <span class="n">WeightGetter</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">DataWeightGetter</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;Return the weight matrix for a given observation matrix.&quot;&quot;&quot;</span>
    <span class="n">minimal_value_matrix_getter</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span>
    <span class="sd">&quot;&quot;&quot;Return the minium values for the V matrix.</span>

<span class="sd">    Takes in the shape of V.</span>

<span class="sd">    Warning:</span>
<span class="sd">        It is a known bug that the minimal value is not respected by all factorizers.&quot;&quot;&quot;</span>
    <span class="n">initial_basic_profiles_getter</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">]</span> <span class="o">=</span> <span class="n">initialize_basis</span>
    <span class="sd">&quot;&quot;&quot;Return the initial state for the basic profiles matrix V.</span>

<span class="sd">    Takes in the dimensions of the observation matrix.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">get_short_model_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return a short string representing the model.</span>

<span class="sd">        The short name consists of three fields, shift, convolution, and weights.</span>
<span class="sd">        Sample names are scmf, l2mf.&quot;&quot;&quot;</span>

        <span class="c1"># Map possible difference_matrix_getters to string representations</span>
        <span class="n">convolution_mapping</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">:</span> <span class="s2">&quot;l2&quot;</span><span class="p">,</span>
            <span class="n">convoluted_differences_matrix</span><span class="p">:</span> <span class="s2">&quot;c&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift_budget</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="n">convolution_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">difference_matrix_getter</span><span class="p">,</span> <span class="s2">&quot;?&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_matrix_getter</span><span class="o">.</span><span class="n">is_identity</span> <span class="k">else</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;mf&quot;</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h4 id="matfact.model.config.ModelConfig.difference_matrix_getter" class="doc doc-heading">
<code class="highlight language-python"><span class="n">difference_matrix_getter</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">],</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
  </span>

</h4>


  <div class="doc doc-contents ">
  
      <p>Return the difference matrix to use for regularization.</p>
<p>Takes in the time dimension size of the observation matrix.</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">



<h4 id="matfact.model.config.ModelConfig.initial_basic_profiles_getter" class="doc doc-heading">
<code class="highlight language-python"><span class="n">initial_basic_profiles_getter</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">]</span> <span class="o">=</span> <span class="n">initialize_basis</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
  </span>

</h4>


  <div class="doc doc-contents ">
  
      <p>Return the initial state for the basic profiles matrix V.</p>
<p>Takes in the dimensions of the observation matrix.</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">



<h4 id="matfact.model.config.ModelConfig.minimal_value_matrix_getter" class="doc doc-heading">
<code class="highlight language-python"><span class="n">minimal_value_matrix_getter</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
  </span>

</h4>


  <div class="doc doc-contents ">
  
      <p>Return the minium values for the V matrix.</p>
<p>Takes in the shape of V.</p>

<details class="warning">
  <summary>Warning</summary>
  <p>It is a known bug that the minimal value is not respected by all factorizers.</p>
</details>  </div>

</div>

<div class="doc doc-object doc-attribute">



<h4 id="matfact.model.config.ModelConfig.weight_matrix_getter" class="doc doc-heading">
<code class="highlight language-python"><span class="n">weight_matrix_getter</span><span class="p">:</span> <span class="n">WeightGetter</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">DataWeightGetter</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
  </span>

</h4>


  <div class="doc doc-contents ">
  
      <p>Return the weight matrix for a given observation matrix.</p>
  </div>

</div>



<div class="doc doc-object doc-function">



<h4 id="matfact.model.config.ModelConfig.get_short_model_name" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_short_model_name</span><span class="p">()</span></code>

</h4>


  <div class="doc doc-contents ">
  
      <p>Return a short string representing the model.</p>
<p>The short name consists of three fields, shift, convolution, and weights.
Sample names are scmf, l2mf.</p>

      <details class="quote">
        <summary>Source code in <code>matfact/model/config.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_short_model_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Return a short string representing the model.</span>

<span class="sd">    The short name consists of three fields, shift, convolution, and weights.</span>
<span class="sd">    Sample names are scmf, l2mf.&quot;&quot;&quot;</span>

    <span class="c1"># Map possible difference_matrix_getters to string representations</span>
    <span class="n">convolution_mapping</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">:</span> <span class="s2">&quot;l2&quot;</span><span class="p">,</span>
        <span class="n">convoluted_differences_matrix</span><span class="p">:</span> <span class="s2">&quot;c&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift_budget</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="n">convolution_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">difference_matrix_getter</span><span class="p">,</span> <span class="s2">&quot;?&quot;</span><span class="p">),</span>
                <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_matrix_getter</span><span class="o">.</span><span class="n">is_identity</span> <span class="k">else</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="o">+</span> <span class="s2">&quot;mf&quot;</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>




  </div>

  </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="matfact.model" class="doc doc-heading">
          <span class="doc doc-object-name doc-module-name">matfact.model</span>


</h2>

  <div class="doc doc-contents first">

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="matfact.model.train_and_log" class="doc doc-heading">
        <span class="doc doc-object-name doc-function-name">train_and_log</span>


</h3>
<div class="highlight"><pre><span></span><code><span class="n">train_and_log</span><span class="p">(</span>
    <span class="n">X_train</span><span class="p">,</span>
    <span class="n">X_test</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">epoch_generator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">dict_to_log</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">extra_metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">log_loss</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">logger_context</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">use_threshold_optimization</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">hyperparams</span>
<span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Train model and log in MLFlow.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>X_train</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>Training data.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>X_test</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>Test data</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dict_to_log</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[dict]</code>
          </td>
          <td><p>optional dictionary associated with the run, logged with MLFlow.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>extra_metrics</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[dict[str, <span title="typing.Callable">Callable</span>[[<span title="typing.Type">Type</span>[<a class="autorefs autorefs-internal" title="matfact.model.BaseMF" href="#matfact.model.factorization.BaseMF">BaseMF</a>]], float]]]</code>
          </td>
          <td><p>optional dictionary of metrics logged in each epoch of training.
See <code>BaseMF.matrix_completion</code> for more details.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>log_loss</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>Whether the loss function as function of epoch should be logged
in MLFlow. Note that this is slow.</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>nested</code></td>
          <td>
          </td>
          <td><p>If True, the run is logged as a nested run in MLFlow, useful in for
example hyperparameter search. Assumes there to exist an active parent run.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>use_threshold_optimization</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>Use ClassificationTree optimization to find
thresholds for class selection.
Can improve results on data skewed towards normal.</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td><p>A dictionary of relevant output statistics.</p></td>
        </tr>
    </tbody>
  </table>
      <div class="admonition note">
<p class="admonition-title">Cross-validation</p>
<p>Concerning cross validation: the function accepts a train and test set. In order
to do for example cross validation hyperparameter search, simply wrap this
function in cross validation logic.
In this case, each run will be logged separately.</p>
<p>In future versions of this package, it is possible that cross validation will
be supported directly from within this function.
However, it is not obvious what we should log, as we log for example the
loss function of each training run.
Two examples are to log each run separately or logging all folds together.</p>
</div>

      <details class="quote">
        <summary>Source code in <code>matfact/model/util.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">train_and_log</span><span class="p">(</span>
    <span class="n">X_train</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">X_test</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">epoch_generator</span><span class="p">:</span> <span class="n">EpochGenerator</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dict_to_log</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">extra_metrics</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Type</span><span class="p">[</span><span class="n">BaseMF</span><span class="p">]],</span> <span class="nb">float</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">log_loss</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">logger_context</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">use_threshold_optimization</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="o">**</span><span class="n">hyperparams</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Train model and log in MLFlow.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        X_train: Training data.</span>
<span class="sd">        X_test: Test data</span>
<span class="sd">        dict_to_log:  optional dictionary associated with the run, logged with MLFlow.</span>
<span class="sd">        extra_metrics: optional dictionary of metrics logged in each epoch of training.</span>
<span class="sd">            See `BaseMF.matrix_completion` for more details.</span>
<span class="sd">        log_loss: Whether the loss function as function of epoch should be logged</span>
<span class="sd">            in MLFlow. Note that this is slow.</span>
<span class="sd">        nested: If True, the run is logged as a nested run in MLFlow, useful in for</span>
<span class="sd">            example hyperparameter search. Assumes there to exist an active parent run.</span>
<span class="sd">        use_threshold_optimization: Use ClassificationTree optimization to find</span>
<span class="sd">            thresholds for class selection.</span>
<span class="sd">            Can improve results on data skewed towards normal.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dictionary of relevant output statistics.</span>


<span class="sd">    !!! Note &quot;Cross-validation&quot;</span>

<span class="sd">        Concerning cross validation: the function accepts a train and test set. In order</span>
<span class="sd">        to do for example cross validation hyperparameter search, simply wrap this</span>
<span class="sd">        function in cross validation logic.</span>
<span class="sd">        In this case, each run will be logged separately.</span>

<span class="sd">        In future versions of this package, it is possible that cross validation will</span>
<span class="sd">        be supported directly from within this function.</span>
<span class="sd">        However, it is not obvious what we should log, as we log for example the</span>
<span class="sd">        loss function of each training run.</span>
<span class="sd">        Two examples are to log each run separately or logging all folds together.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">logger_context</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger_context</span> <span class="o">=</span> <span class="n">MLFlowLogger</span><span class="p">()</span>

    <span class="n">metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">extra_metrics</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="n">extra_metrics</span> <span class="k">else</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">log_loss</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;loss&quot;</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;log_loss True and loss is in extra_metrics. &quot;</span>
                <span class="s2">&quot;This is illegal, as it causes name collision!&quot;</span>
            <span class="p">)</span>
        <span class="n">metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;loss&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">logger_context</span> <span class="k">as</span> <span class="n">logger</span><span class="p">:</span>

        <span class="c1"># Create model</span>
        <span class="n">factoriser</span> <span class="o">=</span> <span class="n">model_factory</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="o">**</span><span class="n">hyperparams</span><span class="p">)</span>

        <span class="c1"># Fit model</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">factoriser</span><span class="o">.</span><span class="n">matrix_completion</span><span class="p">(</span>
            <span class="n">extra_metrics</span><span class="o">=</span><span class="n">extra_metrics</span><span class="p">,</span> <span class="n">epoch_generator</span><span class="o">=</span><span class="n">epoch_generator</span>
        <span class="p">)</span>

        <span class="c1"># Predict</span>
        <span class="n">X_test_masked</span><span class="p">,</span> <span class="n">t_pred</span><span class="p">,</span> <span class="n">x_true</span> <span class="o">=</span> <span class="n">prediction_data</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
        <span class="n">p_pred</span> <span class="o">=</span> <span class="n">factoriser</span><span class="o">.</span><span class="n">predict_probability</span><span class="p">(</span><span class="n">X_test_masked</span><span class="p">,</span> <span class="n">t_pred</span><span class="p">)</span>

        <span class="n">mlflow_output</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;metrics&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;meta&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">use_threshold_optimization</span><span class="p">:</span>
            <span class="c1"># Find the optimal threshold values</span>
            <span class="n">X_train_masked</span><span class="p">,</span> <span class="n">t_pred_train</span><span class="p">,</span> <span class="n">x_true_train</span> <span class="o">=</span> <span class="n">prediction_data</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
            <span class="n">p_pred_train</span> <span class="o">=</span> <span class="n">factoriser</span><span class="o">.</span><span class="n">predict_probability</span><span class="p">(</span><span class="n">X_train_masked</span><span class="p">,</span> <span class="n">t_pred_train</span><span class="p">)</span>
            <span class="n">classification_tree</span> <span class="o">=</span> <span class="n">estimate_probability_thresholds</span><span class="p">(</span>
                <span class="n">x_true_train</span><span class="p">,</span> <span class="n">p_pred_train</span>
            <span class="p">)</span>
            <span class="n">threshold_values</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sa">f</span><span class="s2">&quot;classification_tree_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">value</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">classification_tree</span><span class="o">.</span><span class="n">get_params</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>
            <span class="n">mlflow_output</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">threshold_values</span><span class="p">)</span>

            <span class="c1"># Use threshold values on the test set</span>
            <span class="n">x_pred</span> <span class="o">=</span> <span class="n">classification_tree</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">p_pred</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Simply choose the class with the highest probability</span>
            <span class="c1"># Class labels are 1-indexed, so add one to the arg index.</span>
            <span class="n">x_pred</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">p_pred</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Score</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">matthews_corrcoef</span><span class="p">(</span><span class="n">x_pred</span><span class="p">,</span> <span class="n">x_true</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="n">score</span><span class="p">,</span>
                <span class="s2">&quot;p_pred&quot;</span><span class="p">:</span> <span class="n">p_pred</span><span class="p">,</span>
                <span class="s2">&quot;x_pred&quot;</span><span class="p">:</span> <span class="n">x_pred</span><span class="p">,</span>
                <span class="s2">&quot;x_true&quot;</span><span class="p">:</span> <span class="n">x_true</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="n">mlflow_output</span><span class="p">[</span><span class="s2">&quot;meta&quot;</span><span class="p">][</span><span class="s2">&quot;results&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span>

        <span class="c1"># Logging</span>
        <span class="n">mlflow_output</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">hyperparams</span><span class="p">)</span>
        <span class="n">mlflow_output</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">][</span><span class="s2">&quot;model_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">factoriser</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_short_model_name</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dict_to_log</span><span class="p">:</span>
            <span class="n">mlflow_output</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dict_to_log</span><span class="p">)</span>

        <span class="n">mlflow_output</span><span class="p">[</span><span class="s2">&quot;metrics&quot;</span><span class="p">][</span><span class="s2">&quot;matthew_score&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">score</span>
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
            <span class="n">mlflow_output</span><span class="p">[</span><span class="s2">&quot;metrics&quot;</span><span class="p">][</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span>
        <span class="n">logger</span><span class="p">(</span><span class="n">mlflow_output</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mlflow_output</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="matfact.model.factorization" class="doc doc-heading">
          <code>matfact.model.factorization</code>


</h2>

  <div class="doc doc-contents first">

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h3 id="matfact.model.factorization.BaseMF" class="doc doc-heading">
        <code>BaseMF</code>


</h3>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="abc.ABC">ABC</span></code></p>

  
      <p>Base class for matrix factorization algorithms.</p>


        <details class="quote">
          <summary>Source code in <code>matfact/model/factorization/factorizers/mfbase.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">BaseMF</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
    <span class="s2">&quot;Base class for matrix factorization algorithms.&quot;</span>

    <span class="n">X</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span>
    <span class="n">U</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span>
    <span class="n">V</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span>

    <span class="nd">@property</span>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">M</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="o">...</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">run_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">loss</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">predict_probability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observed_data</span><span class="p">,</span> <span class="n">t_pred</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Predict the probability of the possible states at t_pred&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">predict_proba</span><span class="p">(</span>
            <span class="n">observed_data</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">,</span>
            <span class="n">t_pred</span><span class="p">,</span>
            <span class="n">theta_mle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">),</span>
            <span class="n">number_of_states</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">number_of_states</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">matrix_completion</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">extra_metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">epoch_generator</span><span class="p">:</span> <span class="n">EpochGenerator</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run matrix completion on input matrix X using a factorization model.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            extra_metrics: Dict of name, callable pairs for extra metric logging.</span>
<span class="sd">                Callable must have the signature `(model: Type[BaseMF]) -&gt; Float`.</span>
<span class="sd">            epoch_generator:  A generator of epoch numbers. Defaults to</span>
<span class="sd">                [`ConvergenceMonitor`][matfact.model.factorization.convergence.ConvergenceMonitor]</span>
<span class="sd">                which implements eager termination if detecting convergence.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">epoch_generator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">epoch_generator</span> <span class="o">=</span> <span class="n">ConvergenceMonitor</span><span class="p">()</span>

        <span class="c1"># Results collected from the process</span>
        <span class="n">output</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;loss&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;epochs&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;U&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;V&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;M&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;s&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;theta_mle&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">extra_metrics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">extra_metrics</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">extra_metrics</span><span class="p">:</span>
            <span class="n">output</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="n">epoch_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">run_step</span><span class="p">()</span>

            <span class="n">output</span><span class="p">[</span><span class="s2">&quot;epochs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">epoch</span><span class="p">))</span>
            <span class="n">output</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">()))</span>
            <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">callable</span> <span class="ow">in</span> <span class="n">extra_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">output</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

        <span class="n">output</span><span class="p">[</span><span class="s2">&quot;U&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">U</span>
        <span class="n">output</span><span class="p">[</span><span class="s2">&quot;V&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span>
        <span class="n">output</span><span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span>
        <span class="n">output</span><span class="p">[</span><span class="s2">&quot;s&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">output</span><span class="p">[</span><span class="s2">&quot;theta_mle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">theta_mle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">output</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h4 id="matfact.model.factorization.factorizers.mfbase.BaseMF.matrix_completion" class="doc doc-heading">
<code class="highlight language-python"><span class="n">matrix_completion</span><span class="p">(</span><span class="n">extra_metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">epoch_generator</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


  <div class="doc doc-contents ">
  
      <p>Run matrix completion on input matrix X using a factorization model.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>extra_metrics</code></td>
          <td>
          </td>
          <td><p>Dict of name, callable pairs for extra metric logging.
Callable must have the signature <code>(model: Type[BaseMF]) -&gt; Float</code>.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>epoch_generator</code></td>
          <td>
                <code><span title="matfact.model.factorization.convergence.EpochGenerator">EpochGenerator</span> | None</code>
          </td>
          <td><p>A generator of epoch numbers. Defaults to
<a class="autorefs autorefs-internal" href="#matfact.model.factorization.convergence.ConvergenceMonitor"><code>ConvergenceMonitor</code></a>
which implements eager termination if detecting convergence.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>matfact/model/factorization/factorizers/mfbase.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">matrix_completion</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">extra_metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">epoch_generator</span><span class="p">:</span> <span class="n">EpochGenerator</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Run matrix completion on input matrix X using a factorization model.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        extra_metrics: Dict of name, callable pairs for extra metric logging.</span>
<span class="sd">            Callable must have the signature `(model: Type[BaseMF]) -&gt; Float`.</span>
<span class="sd">        epoch_generator:  A generator of epoch numbers. Defaults to</span>
<span class="sd">            [`ConvergenceMonitor`][matfact.model.factorization.convergence.ConvergenceMonitor]</span>
<span class="sd">            which implements eager termination if detecting convergence.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">epoch_generator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">epoch_generator</span> <span class="o">=</span> <span class="n">ConvergenceMonitor</span><span class="p">()</span>

    <span class="c1"># Results collected from the process</span>
    <span class="n">output</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;loss&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;epochs&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;U&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;V&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;M&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;s&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;theta_mle&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">extra_metrics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">extra_metrics</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">extra_metrics</span><span class="p">:</span>
        <span class="n">output</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="n">epoch_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">run_step</span><span class="p">()</span>

        <span class="n">output</span><span class="p">[</span><span class="s2">&quot;epochs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">epoch</span><span class="p">))</span>
        <span class="n">output</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">()))</span>
        <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">callable</span> <span class="ow">in</span> <span class="n">extra_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">output</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="n">output</span><span class="p">[</span><span class="s2">&quot;U&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">U</span>
    <span class="n">output</span><span class="p">[</span><span class="s2">&quot;V&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span>
    <span class="n">output</span><span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span>
    <span class="n">output</span><span class="p">[</span><span class="s2">&quot;s&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">output</span><span class="p">[</span><span class="s2">&quot;theta_mle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">theta_mle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="matfact.model.factorization.factorizers.mfbase.BaseMF.predict_probability" class="doc doc-heading">
<code class="highlight language-python"><span class="n">predict_probability</span><span class="p">(</span><span class="n">observed_data</span><span class="p">,</span> <span class="n">t_pred</span><span class="p">)</span></code>

</h4>


  <div class="doc doc-contents ">
  
      <p>Predict the probability of the possible states at t_pred</p>

      <details class="quote">
        <summary>Source code in <code>matfact/model/factorization/factorizers/mfbase.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">predict_probability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observed_data</span><span class="p">,</span> <span class="n">t_pred</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Predict the probability of the possible states at t_pred&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">predict_proba</span><span class="p">(</span>
        <span class="n">observed_data</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">,</span>
        <span class="n">t_pred</span><span class="p">,</span>
        <span class="n">theta_mle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">),</span>
        <span class="n">number_of_states</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">number_of_states</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="matfact.model.factorization.CMF" class="doc doc-heading">
        <code>CMF</code>


</h3>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><a class="autorefs autorefs-internal" title="matfact.model.factorization.factorizers.mfbase.BaseMF" href="#matfact.model.factorization.BaseMF">BaseMF</a></code></p>

  
      <p>Matrix factorization with L2 and convolutional regularization.
Factor updates are based on analytical estimates and will therefore
not permit and arbitrary weight matrix in the discrepancy term.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>X</code></td>
          <td>
          </td>
          <td><p>Sparse data matrix used to estimate factor matrices</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>V</code></td>
          <td>
          </td>
          <td><p>Initial estimate for basic vectors</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>config</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="matfact.model.config.ModelConfig" href="#matfact.model.config.ModelConfig">ModelConfig</a></code>
          </td>
          <td><p>Configuration model.
shift and weights are ignored in the CMF factorizer.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>matfact/model/factorization/factorizers/cmf.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">CMF</span><span class="p">(</span><span class="n">BaseMF</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Matrix factorization with L2 and convolutional regularization.</span>
<span class="sd">    Factor updates are based on analytical estimates and will therefore</span>
<span class="sd">    not permit and arbitrary weight matrix in the discrepancy term.</span>

<span class="sd">    Args:</span>
<span class="sd">            X: Sparse data matrix used to estimate factor matrices</span>
<span class="sd">            V: Initial estimate for basic vectors</span>
<span class="sd">            config: Configuration model.</span>
<span class="sd">              shift and weights are ignored in the CMF factorizer.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">X</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">weight_matrix_getter</span><span class="o">.</span><span class="n">is_identity</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;CMF given a non-identity weight. This will be ignored.&quot;</span>
                <span class="s2">&quot;Consider using WCMF or SCMF.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">shift_budget</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;CMF given a non-empty shift budget. This will be ignored.&quot;</span>
                <span class="s2">&quot;Consider using SCMF.&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">X</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">V</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">initial_basic_profiles_getter</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">config</span><span class="o">.</span><span class="n">rank</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nz_rows</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nz_cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_iter_</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">KD</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">difference_matrix_getter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">J</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">minimal_value_matrix_getter</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">rank</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_matrices</span><span class="p">(</span><span class="n">KD</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_U</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">M</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">U</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_init_matrices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">KD</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">I_l1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">lambda1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">rank</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">I_l2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">lambda2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">rank</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">KD</span> <span class="o">=</span> <span class="n">KD</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DTKTKD</span> <span class="o">=</span> <span class="n">KD</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">KD</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">lambda3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">DTKTKD</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_V</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">L1</span><span class="p">,</span> <span class="n">Q1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">U</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">I_l2</span><span class="p">)</span>

        <span class="n">hatV</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Q2</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">U</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">lambda2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">J</span><span class="p">))</span>
            <span class="o">@</span> <span class="n">Q1</span>
            <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L2</span><span class="p">,</span> <span class="n">L1</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">V</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q2</span> <span class="o">@</span> <span class="p">(</span><span class="n">hatV</span> <span class="o">@</span> <span class="n">Q1</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_U</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">U</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">I_l1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_S</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">U</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="o">.</span><span class="n">T</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nz_rows</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nz_cols</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nz_rows</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nz_cols</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">loss</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Compute the loss from the optimization objective&quot;</span>

        <span class="n">loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">U</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="o">.</span><span class="n">T</span><span class="p">)))</span>
        <span class="n">loss</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">lambda1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="p">))</span>
        <span class="n">loss</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">lambda2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">J</span><span class="p">))</span>
        <span class="n">loss</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">lambda3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KD</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">loss</span>

    <span class="k">def</span> <span class="nf">run_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Perform one step of alternating minimization&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_update_U</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_V</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_S</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_iter_</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="matfact.model.factorization.SCMF" class="doc doc-heading">
        <code>SCMF</code>


</h3>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><a class="autorefs autorefs-internal" title="matfact.model.factorization.factorizers.mfbase.BaseMF" href="#matfact.model.factorization.BaseMF">BaseMF</a></code></p>

  
      <p>Shifted matrix factorization with L2 and convolutional regularization (optional).</p>
<p>Factor updates are based on gradient descent approximations, permitting an arbitrary
weight matrix in the discrepancy term. The shift mechanism will maximize the
correlation between vector samples in the original and estimated data matrices for
more accurate factor estimates.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>X</code></td>
          <td>
          </td>
          <td><p>Sparse data matrix used to estimate factor matrices</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>V</code></td>
          <td>
          </td>
          <td><p>Initial estimate for basic vectors</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>config</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="matfact.model.config.ModelConfig" href="#matfact.model.config.ModelConfig">ModelConfig</a></code>
          </td>
          <td><p>Configuration model.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

<details class="discussion-on-internal-matrices">
  <summary>Discussion on internal matrices</summary>
  <p>There are four X matrices (correspondingly for W):</p>
<ul>
<li>X : The original input matrix</li>
<li>X_bc : The original input matrix with padded zeros on the time axis.</li>
<li>X_shifted : Similar to X_bc, but each row is shifted according to self.s.</li>
<li>X_shifts : A stack of size(s_budged) arrays similar to X_bc, but each shifted
    horizontally (time axis). Stack layer i is shifted s_budged[i].</li>
</ul>
<p>X_shifted is the only matrix altered after initialization.</p>
</details>

        <details class="quote">
          <summary>Source code in <code>matfact/model/factorization/factorizers/scmf.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">SCMF</span><span class="p">(</span><span class="n">BaseMF</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Shifted matrix factorization with L2 and convolutional regularization (optional).</span>

<span class="sd">    Factor updates are based on gradient descent approximations, permitting an arbitrary</span>
<span class="sd">    weight matrix in the discrepancy term. The shift mechanism will maximize the</span>
<span class="sd">    correlation between vector samples in the original and estimated data matrices for</span>
<span class="sd">    more accurate factor estimates.</span>

<span class="sd">    Args:</span>
<span class="sd">        X: Sparse data matrix used to estimate factor matrices</span>
<span class="sd">        V: Initial estimate for basic vectors</span>
<span class="sd">        config: Configuration model.</span>

<span class="sd">    Discussion on internal matrices:</span>
<span class="sd">        There are four X matrices (correspondingly for W):</span>

<span class="sd">        - X : The original input matrix</span>
<span class="sd">        - X_bc : The original input matrix with padded zeros on the time axis.</span>
<span class="sd">        - X_shifted : Similar to X_bc, but each row is shifted according to self.s.</span>
<span class="sd">        - X_shifts : A stack of size(s_budged) arrays similar to X_bc, but each shifted</span>
<span class="sd">            horizontally (time axis). Stack layer i is shifted s_budged[i].</span>

<span class="sd">        X_shifted is the only matrix altered after initialization.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">X</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span>
    <span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">weight_matrix_getter</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="n">V</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">initial_basic_profiles_getter</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">config</span><span class="o">.</span><span class="n">rank</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nz_rows</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nz_cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_iter_</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># The shift amount per row</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="c1"># The number of possible shifts. Used for padding of arrays.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ns</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">shift_budget</span><span class="p">)</span>

        <span class="c1"># Add time points to cover extended left and right boundaries when shifting.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">KD</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">difference_matrix_getter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ns</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">I1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">lambda1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">rank</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">I2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">lambda2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">rank</span><span class="p">)</span>

        <span class="c1"># Expand matrices with zeros over the extended left and right boundaries.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_bc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
            <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ns</span><span class="p">)),</span> <span class="n">X</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ns</span><span class="p">))]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_bc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
            <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ns</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ns</span><span class="p">))]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">V_bc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Ns</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">rank</span><span class="p">)),</span>
                <span class="n">V</span><span class="p">,</span>
                <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Ns</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">rank</span><span class="p">)),</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="c1"># We know V_bc to be two-dimensional, so cast to please mypy.</span>
        <span class="n">J_shape</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_bc</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="c1"># TODO: do we have to cast this to tf float32?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">J</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">minimal_value_matrix_getter</span><span class="p">(</span><span class="n">J_shape</span><span class="p">)</span>

        <span class="c1"># Implementation shifts W and Y (not UV.T)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_shifted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_bc</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_shifted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_bc</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fill_boundary_regions_V_bc</span><span class="p">()</span>

        <span class="c1"># Placeholders (s x N x T) for all possible candidate shits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Ns</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">X_bc</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Ns</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">W_bc</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

        <span class="c1"># Shift Y in opposite direction of V shift.</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">s_n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">shift_budget</span><span class="p">):</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">X_shifts</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_bc</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">s_n</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">W_shifts</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">W_bc</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">s_n</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">U</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exactly_solve_U</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">X</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># return self.X_bc[:, self.Ns:-self.Ns]</span>
        <span class="k">return</span> <span class="n">_take_per_row_strided</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_shifted</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ns</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">n_elem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">V</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;To be compatible with the expectation of having a V&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_bc</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">M</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># Compute the reconstructed matrix with sample-specific shifts</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">_take_per_row_strided</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">U</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_bc</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">start_idx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Ns</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">n_elem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">T</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_shift_X_W</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">X_shifted</span> <span class="o">=</span> <span class="n">_custom_roll</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_bc</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_shifted</span> <span class="o">=</span> <span class="n">_custom_roll</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">W_bc</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_fill_boundary_regions_V_bc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extrapolate the edge values in V_bc over the extended boundaries&quot;&quot;&quot;</span>

        <span class="n">V_filled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V_bc</span><span class="p">)</span>

        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ns</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V_bc</span><span class="o">.</span><span class="n">T</span><span class="p">):</span>

            <span class="n">v_left</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">idx</span> <span class="o">&lt;=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)]</span>
            <span class="n">v_right</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">idx</span> <span class="o">&gt;</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)]</span>

            <span class="n">v_left</span><span class="p">[</span><span class="n">v_left</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_left</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">v_left</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)]</span>
            <span class="n">v_right</span><span class="p">[</span><span class="n">v_right</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_right</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">v_right</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))]</span>

            <span class="n">V_filled</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">v_left</span><span class="p">,</span> <span class="n">v_right</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">V_bc</span> <span class="o">=</span> <span class="n">V_filled</span>

    <span class="k">def</span> <span class="nf">_update_V</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V_bc</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="c1"># @tf.function</span>
        <span class="k">def</span> <span class="nf">_loss_V</span><span class="p">():</span>

            <span class="n">frob_tensor</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">W_shifted</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_shifted</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">U</span> <span class="o">@</span> <span class="n">tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">V</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="n">frob_loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">frob_tensor</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

            <span class="n">l2_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">lambda2</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">((</span><span class="n">V</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">J</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">conv_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">lambda3</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span>
                <span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KD</span><span class="p">,</span> <span class="n">V</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="n">frob_loss</span> <span class="o">+</span> <span class="n">l2_loss</span> <span class="o">+</span> <span class="n">conv_loss</span>

        <span class="n">optimiser</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">tf</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">iter_V</span><span class="p">):</span>
            <span class="n">optimiser</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">_loss_V</span><span class="p">,</span> <span class="p">[</span><span class="n">V</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">V_bc</span> <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_exactly_solve_U</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Solve for U at a fixed V.</span>

<span class="sd">        The internal U member is not modified by this method.</span>
<span class="sd">        V is assumed to be initialized.&quot;&quot;&quot;</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">rank</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">):</span>
            <span class="n">U</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">X_shifted</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
                <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_bc</span>
                <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">V_bc</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">W_shifted</span><span class="p">[</span><span class="n">n</span><span class="p">])</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_bc</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">I1</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">U</span>

    <span class="k">def</span> <span class="nf">_approx_U</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">U</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="c1"># @tf.function</span>
        <span class="k">def</span> <span class="nf">_loss_U</span><span class="p">():</span>

            <span class="n">frob_tensor</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">W_shifted</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">X_shifted</span> <span class="o">-</span> <span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_bc</span><span class="p">,</span> <span class="n">transpose_b</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">frob_loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">((</span><span class="n">frob_tensor</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">frob_loss</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">lambda1</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">U</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">optimiser</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">tf</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">iter_U</span><span class="p">):</span>
            <span class="n">optimiser</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">_loss_U</span><span class="p">,</span> <span class="p">[</span><span class="n">U</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">U</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_update_s</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># Evaluate the discrepancy term for all possible shift candidates</span>
        <span class="n">M</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">U</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_bc</span><span class="o">.</span><span class="n">T</span>
        <span class="n">D</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">W_shifts</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_shifts</span> <span class="o">-</span> <span class="n">M</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="o">**</span> <span class="mi">2</span>
        <span class="p">)</span>

        <span class="c1"># Selected shifts maximize the correlation between X and M</span>
        <span class="n">s_new</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">shift_budget</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)]</span>

        <span class="c1"># Update attributes only if changes to the optimal shift</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">s_new</span><span class="p">):</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">s_new</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_shift_X_W</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">run_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Perform one step of alternating minimization&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">U</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_approx_U</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_V</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_s</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_iter_</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">loss</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Compute the loss from the optimization objective&quot;</span>

        <span class="n">loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">W_shifted</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_shifted</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">U</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_bc</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span>
            <span class="o">**</span> <span class="mi">2</span>
        <span class="p">)</span>
        <span class="n">loss</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">lambda1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">lambda2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V_bc</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">loss</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">lambda3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KD</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_bc</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

        <span class="k">return</span> <span class="n">loss</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h4 id="matfact.model.factorization.factorizers.scmf.SCMF.V" class="doc doc-heading">
<code class="highlight language-python"><span class="n">V</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


  <div class="doc doc-contents ">
  
      <p>To be compatible with the expectation of having a V</p>
  </div>

</div>





  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="matfact.model.factorization.WCMF" class="doc doc-heading">
        <code>WCMF</code>


</h3>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><a class="autorefs autorefs-internal" title="matfact.model.factorization.factorizers.mfbase.BaseMF" href="#matfact.model.factorization.BaseMF">BaseMF</a></code></p>

  
      <p>Matrix factorization with L2 and convolutional regularization.
Factor updates are based on gradient descent approximations, permitting
an arbitrary weight matrix in the discrepancy term.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>X</code></td>
          <td>
          </td>
          <td><p>Sparse data matrix used to estimate factor matrices</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>V</code></td>
          <td>
          </td>
          <td><p>Initial estimate for basic vectors</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>config</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="matfact.model.config.ModelConfig" href="#matfact.model.config.ModelConfig">ModelConfig</a></code>
          </td>
          <td><p>Configuration model.
shift is ignored in the WCMF factorizer.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>matfact/model/factorization/factorizers/wcmf.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">WCMF</span><span class="p">(</span><span class="n">BaseMF</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Matrix factorization with L2 and convolutional regularization.</span>
<span class="sd">    Factor updates are based on gradient descent approximations, permitting</span>
<span class="sd">    an arbitrary weight matrix in the discrepancy term.</span>

<span class="sd">    Args:</span>
<span class="sd">        X: Sparse data matrix used to estimate factor matrices</span>
<span class="sd">        V: Initial estimate for basic vectors</span>
<span class="sd">        config: Configuration model.</span>
<span class="sd">          shift is ignored in the WCMF factorizer.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">X</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">shift_budget</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;WCMF given a non-empty shift budget. This will be ignored.&quot;</span>
                <span class="s2">&quot;Consider using SCMF.&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">X</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">V</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">initial_basic_profiles_getter</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">config</span><span class="o">.</span><span class="n">rank</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">weight_matrix_getter</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nz_rows</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nz_cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_iter_</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">KD</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">difference_matrix_getter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">J</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">minimal_value_matrix_getter</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">rank</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_matrices</span><span class="p">(</span><span class="n">KD</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">U</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exactly_solve_U</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">M</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">U</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_init_matrices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">KD</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">KD</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">KD</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DTKTKD</span> <span class="o">=</span> <span class="n">KD</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">KD</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">I_l1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">lambda1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">rank</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_V</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># @tf.function</span>
        <span class="k">def</span> <span class="nf">_loss_V</span><span class="p">():</span>
            <span class="n">frob_tensor</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">X</span> <span class="o">-</span> <span class="p">(</span><span class="n">U</span> <span class="o">@</span> <span class="n">tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">V</span><span class="p">)))</span>
            <span class="n">frob_loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">frob_tensor</span><span class="p">))</span>

            <span class="n">l2_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">lambda2</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">V</span> <span class="o">-</span> <span class="n">J</span><span class="p">))</span>

            <span class="n">conv_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">lambda3</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KD</span><span class="p">,</span> <span class="n">V</span><span class="p">)))</span>

            <span class="k">return</span> <span class="n">frob_loss</span> <span class="o">+</span> <span class="n">l2_loss</span> <span class="o">+</span> <span class="n">conv_loss</span>

        <span class="n">V</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">J</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="n">W</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="n">optimiser</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">tf</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">iter_V</span><span class="p">):</span>
            <span class="n">optimiser</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">_loss_V</span><span class="p">,</span> <span class="p">[</span><span class="n">V</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">V</span> <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_exactly_solve_U</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Solve for U at a fixed V.</span>

<span class="sd">        The internal U member is not modified by this method.</span>
<span class="sd">        V is assumed to be initialized.&quot;&quot;&quot;</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">rank</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">):</span>
            <span class="n">U</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="o">.</span><span class="n">T</span>
                <span class="o">@</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
                <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="n">n</span><span class="p">][:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">I_l1</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">U</span>

    <span class="k">def</span> <span class="nf">_approx_U</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># @tf.function</span>
        <span class="k">def</span> <span class="nf">_loss_U</span><span class="p">():</span>
            <span class="n">frob_tensor</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">X</span> <span class="o">-</span> <span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">transpose_b</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="n">frob_loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">frob_tensor</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">frob_loss</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">lambda1</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">U</span><span class="p">))</span>

        <span class="n">U</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="n">W</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="n">optimiser</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">tf</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">iter_U</span><span class="p">):</span>
            <span class="n">optimiser</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">_loss_U</span><span class="p">,</span> <span class="p">[</span><span class="n">U</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">U</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">loss</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Compute the loss from the optimization objective&quot;</span>

        <span class="n">loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">U</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="o">.</span><span class="n">T</span><span class="p">)))</span>
        <span class="n">loss</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">lambda1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="p">))</span>
        <span class="n">loss</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">lambda2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">loss</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">lambda3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KD</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">loss</span>

    <span class="k">def</span> <span class="nf">run_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Perform one step of alternating minimization&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">U</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_approx_U</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_V</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_iter_</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>




  </div>

  </div>

</div>

<div class="doc doc-object doc-module">


<a id="matfact.model.factorization.convergence"></a>
  <div class="doc doc-contents first">

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="matfact.model.factorization.convergence.ConvergenceMonitor" class="doc doc-heading">
        <code>ConvergenceMonitor</code>


</h2>


  <div class="doc doc-contents ">

  
      <p>Epoch generator with eager termination when converged.</p>
<p>The model is said to have converged when the model's latent matrix (M) has
a relative norm difference smaller than tolerance.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>number_of_epochs</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>the maximum number of epochs to generate.</p></td>
          <td>
                <code>DEFAULT_NUMBER_OF_EPOCHS</code>
          </td>
        </tr>
        <tr>
          <td><code>epochs_per_val</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>convergence checking is done every epochs_per_val epoch.</p></td>
          <td>
                <code>DEFAULT_EPOCHS_PER_VAL</code>
          </td>
        </tr>
        <tr>
          <td><code>patience</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>the minimum number of epcohs.</p></td>
          <td>
                <code>DEFAULT_PATIENCE</code>
          </td>
        </tr>
        <tr>
          <td><code>show_progress</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>enable tqdm progress bar.</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>tolerance</code></td>
          <td>
                <code>float</code>
          </td>
          <td><p>the tolerance under which the model is said to have converged.</p></td>
          <td>
                <code>0.0001</code>
          </td>
        </tr>
    </tbody>
  </table>

<p><strong>Examples:</strong></p>
    <div class="highlight"><pre><span></span><code><span class="n">monitor</span> <span class="o">=</span> <span class="n">ConvergenceMonitor</span><span class="p">(</span><span class="n">tolerance</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">)</span>
<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="n">monitor</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="c1"># If model converges, the generator will deplete before the default number</span>
    <span class="c1"># of epochs has been reached.</span>
    <span class="o">...</span>
</code></pre></div>


        <details class="quote">
          <summary>Source code in <code>matfact/model/factorization/convergence.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">ConvergenceMonitor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Epoch generator with eager termination when converged.</span>

<span class="sd">    The model is said to have converged when the model&#39;s latent matrix (M) has</span>
<span class="sd">    a relative norm difference smaller than tolerance.</span>


<span class="sd">    Args:</span>
<span class="sd">        number_of_epochs: the maximum number of epochs to generate.</span>
<span class="sd">        epochs_per_val: convergence checking is done every epochs_per_val epoch.</span>
<span class="sd">        patience: the minimum number of epcohs.</span>
<span class="sd">        show_progress: enable tqdm progress bar.</span>
<span class="sd">        tolerance: the tolerance under which the model is said to have converged.</span>

<span class="sd">    Examples:</span>

<span class="sd">        ```python</span>
<span class="sd">        monitor = ConvergenceMonitor(tolerance=1e-5)</span>
<span class="sd">        for epoch in monitor(model):</span>
<span class="sd">            # If model converges, the generator will deplete before the default number</span>
<span class="sd">            # of epochs has been reached.</span>
<span class="sd">            ...</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">number_of_epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_NUMBER_OF_EPOCHS</span><span class="p">,</span>
        <span class="n">epochs_per_val</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_EPOCHS_PER_VAL</span><span class="p">,</span>
        <span class="n">patience</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_PATIENCE</span><span class="p">,</span>
        <span class="n">show_progress</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">tolerance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-4</span><span class="p">,</span>
    <span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">number_of_epochs</span> <span class="o">=</span> <span class="n">number_of_epochs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tolerance</span> <span class="o">=</span> <span class="n">tolerance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epochs_per_val</span> <span class="o">=</span> <span class="n">epochs_per_val</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patience</span> <span class="o">=</span> <span class="n">patience</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_range</span> <span class="o">=</span> <span class="n">trange</span> <span class="k">if</span> <span class="n">show_progress</span> <span class="k">else</span> <span class="nb">range</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_difference_func</span><span class="p">(</span><span class="n">new_M</span><span class="p">,</span> <span class="n">old_M</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">new_M</span> <span class="o">-</span> <span class="n">old_M</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">old_M</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="s2">&quot;BaseMF&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A generator that yields epoch numbers.&quot;&quot;&quot;</span>
        <span class="n">_old_M</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">M</span>
        <span class="n">_model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="c1"># mypy does not recognize the union of trange and range as a callable.</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">number_of_epochs</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
            <span class="k">yield</span> <span class="n">i</span>  <span class="c1"># model is expected to update its M</span>
            <span class="n">should_update</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">patience</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">epochs_per_val</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">should_update</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_difference_func</span><span class="p">(</span><span class="n">_model</span><span class="o">.</span><span class="n">M</span><span class="p">,</span> <span class="n">_old_M</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">tolerance</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">_old_M</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">M</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="matfact.model.factorization.convergence.ConvergenceMonitor.__call__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__call__</span><span class="p">(</span><span class="n">model</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>A generator that yields epoch numbers.</p>

      <details class="quote">
        <summary>Source code in <code>matfact/model/factorization/convergence.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="s2">&quot;BaseMF&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A generator that yields epoch numbers.&quot;&quot;&quot;</span>
    <span class="n">_old_M</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">M</span>
    <span class="n">_model</span> <span class="o">=</span> <span class="n">model</span>
    <span class="c1"># mypy does not recognize the union of trange and range as a callable.</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">number_of_epochs</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
        <span class="k">yield</span> <span class="n">i</span>  <span class="c1"># model is expected to update its M</span>
        <span class="n">should_update</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">patience</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">epochs_per_val</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">should_update</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_difference_func</span><span class="p">(</span><span class="n">_model</span><span class="o">.</span><span class="n">M</span><span class="p">,</span> <span class="n">_old_M</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">tolerance</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">_old_M</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">M</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>




  </div>

  </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="matfact.model.logging" class="doc doc-heading">
          <code>matfact.model.logging</code>


</h2>

  <div class="doc doc-contents first">
  
      <p>Logging utilities.</p>
<p>The logging is written in a general way, however at the moment only MLFlow is supported
as backend.</p>

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h3 id="matfact.model.logging.MLFlowBatchLogger" class="doc doc-heading">
        <code>MLFlowBatchLogger</code>


</h3>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><a class="autorefs autorefs-internal" title="matfact.model.logging.MLFlowLogger" href="#matfact.model.logging.MLFlowLogger">MLFlowLogger</a></code></p>

  
      <p>Context manager for combining multiple run data into one MLFlow run.</p>
<p>Given several run dictionaries, the data is aggregated together to one
summary run, which is logged to MLFlow. Used in for example cross validation runs,
where each fold is a subrun, and the entire cross validation is logged as one run.</p>

<p><strong>Examples:</strong></p>
    <p>It is possible to run MLFlowBatchLogger wrapped around subrun contexts.</p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">MLFlowBatchLogger</span><span class="p">()</span> <span class="k">as</span> <span class="n">outer_logger</span><span class="p">:</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="k">for</span> <span class="n">subrun</span> <span class="ow">in</span> <span class="n">subruns</span><span class="p">:</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="k">with</span> <span class="n">MLFlowLogger</span><span class="p">()</span> <span class="k">as</span> <span class="n">inner_logger</span><span class="p">:</span>
<span class="gp">&gt;&gt;&gt; </span>            <span class="o">...</span>
<span class="gp">&gt;&gt;&gt; </span>            <span class="n">inner_logger</span><span class="p">(</span><span class="n">run_data</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span>            <span class="n">outer_logger</span><span class="p">(</span><span class="n">run_data</span><span class="p">)</span>  <span class="c1"># (1)</span>
</code></pre></div>
    <ol>
<li>
<p>The data is only logged to MLFlow when <code>MLFlowBatchLogger</code> exists.</p>
<details class="note">
<summary>How and when are things logged?</summary>
<p>Each call to the logger is stored as a subrun, which
on exit is aggregated together to one run which is logged to MLFLow.
See <a class="autorefs autorefs-internal" href="#matfact.model.logging.batch_mlflow_logger">matfact.model.logging.batch_mlflow_logger</a> for details.</p>
</details>
</li>
</ol>


        <details class="quote">
          <summary>Source code in <code>matfact/model/logging.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">MLFlowBatchLogger</span><span class="p">(</span><span class="n">MLFlowLogger</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Context manager for combining multiple run data into one MLFlow run.</span>

<span class="sd">    Given several run dictionaries, the data is aggregated together to one</span>
<span class="sd">    summary run, which is logged to MLFlow. Used in for example cross validation runs,</span>
<span class="sd">    where each fold is a subrun, and the entire cross validation is logged as one run.</span>

<span class="sd">    Examples:</span>
<span class="sd">        It is possible to run MLFlowBatchLogger wrapped around subrun contexts.</span>
<span class="sd">        &gt;&gt;&gt; with MLFlowBatchLogger() as outer_logger:</span>
<span class="sd">        &gt;&gt;&gt;     for subrun in subruns:</span>
<span class="sd">        &gt;&gt;&gt;         with MLFlowLogger() as inner_logger:</span>
<span class="sd">        &gt;&gt;&gt;             ...</span>
<span class="sd">        &gt;&gt;&gt;             inner_logger(run_data)</span>
<span class="sd">        &gt;&gt;&gt;             outer_logger(run_data)  # (1)</span>

<span class="sd">        1. The data is only logged to MLFlow when `MLFlowBatchLogger` exists.</span>

<span class="sd">            ??? Note &quot;How and when are things logged?&quot;</span>
<span class="sd">                Each call to the logger is stored as a subrun, which</span>
<span class="sd">                on exit is aggregated together to one run which is logged to MLFLow.</span>
<span class="sd">                See [matfact.model.logging.batch_mlflow_logger][] for details.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">allow_nesting</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">extra_tags</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">aggregate_funcs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">AggregationFunction</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">allow_nesting</span><span class="o">=</span><span class="n">allow_nesting</span><span class="p">,</span> <span class="n">extra_tags</span><span class="o">=</span><span class="n">extra_tags</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aggregate_funcs</span> <span class="o">=</span> <span class="n">aggregate_funcs</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="n">batch_mlflow_logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="n">aggregate_funcs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">aggregate_funcs</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_dict</span><span class="p">):</span>

        <span class="c1"># On call we only append the dict to our list of data.</span>
        <span class="c1"># The actual logging happens on __exit__.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output_dict</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_tags</span><span class="p">:</span>
            <span class="n">mlflow</span><span class="o">.</span><span class="n">set_tags</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extra_tags</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="matfact.model.logging.MLFlowLogger" class="doc doc-heading">
        <code>MLFlowLogger</code>


</h3>


  <div class="doc doc-contents ">

  
      <p>Context manager for MLFlow logging.</p>
<p>Wraps the code inside the corresponding with block in an MLFlow run.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>allow_nesting</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>loggers can be nested within each other, with inside runs being
  logged as children in MLFlow.</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>extra_tags</code></td>
          <td>
                <code>dict | None</code>
          </td>
          <td><p>these tags will be appended to each run.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

<p><strong>Examples:</strong></p>
    <div class="highlight"><pre><span></span><code><span class="k">with</span> <span class="n">MLFlowLogger</span><span class="p">()</span> <span class="k">as</span> <span class="n">logger</span><span class="p">:</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">get_output_data</span><span class="p">()</span>
    <span class="c1"># output = {</span>
    <span class="c1">#     &quot;params&quot;: {...},</span>
    <span class="c1">#     &quot;metrics&quot;: {...},</span>
    <span class="c1">#     &quot;meta&quot;: {...},</span>
    <span class="c1"># }</span>
    <span class="n">logger</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</code></pre></div>

  <p><strong>Raises:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="matfact.model.logging.MLFlowRunHierarchyException">MLFlowRunHierarchyException</span></code>
          </td>
          <td><p>Raised on enter if
loggers are nested when allow_nesting is False.</p></td>
        </tr>
    </tbody>
  </table>

<details class="see-also">
  <summary>See also</summary>
  <ul>
<li><a class="autorefs autorefs-internal" href="#matfact.model.logging.MLFlowBatchLogger">MLFlowBatchLogger</a></li>
<li><a class="autorefs autorefs-internal" href="#matfact.model.logging.MLFlowLoggerArtifact">MLFlowLoggerArtifact</a></li>
<li><a class="autorefs autorefs-internal" href="#matfact.model.logging.MLFlowLoggerDiagnostic">MLFlowLoggerDiagnostic</a></li>
</ul>
</details>

        <details class="quote">
          <summary>Source code in <code>matfact/model/logging.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">MLFlowLogger</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Context manager for MLFlow logging.</span>

<span class="sd">    Wraps the code inside the corresponding with block in an MLFlow run.</span>

<span class="sd">    Arguments:</span>
<span class="sd">     allow_nesting: loggers can be nested within each other, with inside runs being</span>
<span class="sd">        logged as children in MLFlow.</span>
<span class="sd">     extra_tags: these tags will be appended to each run.</span>

<span class="sd">    Examples:</span>

<span class="sd">        ```python</span>
<span class="sd">        with MLFlowLogger() as logger:</span>
<span class="sd">            output = get_output_data()</span>
<span class="sd">            # output = {</span>
<span class="sd">            #     &quot;params&quot;: {...},</span>
<span class="sd">            #     &quot;metrics&quot;: {...},</span>
<span class="sd">            #     &quot;meta&quot;: {...},</span>
<span class="sd">            # }</span>
<span class="sd">            logger(output)</span>
<span class="sd">        ```</span>

<span class="sd">    Raises:</span>
<span class="sd">        MLFlowRunHierarchyException: Raised on enter if</span>
<span class="sd">            loggers are nested when allow_nesting is False.</span>

<span class="sd">    See also:</span>
<span class="sd">        - [MLFlowBatchLogger][matfact.model.logging.MLFlowBatchLogger]</span>
<span class="sd">        - [MLFlowLoggerArtifact][matfact.model.logging.MLFlowLoggerArtifact]</span>
<span class="sd">        - [MLFlowLoggerDiagnostic][matfact.model.logging.MLFlowLoggerDiagnostic]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">allow_nesting</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">extra_tags</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allow_nesting</span> <span class="o">=</span> <span class="n">allow_nesting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra_tags</span> <span class="o">=</span> <span class="n">extra_tags</span> <span class="k">if</span> <span class="n">extra_tags</span> <span class="k">else</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">(</span><span class="n">nested</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">allow_nesting</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;Run with UUID [0-9a-f]+ is already active.&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">e</span><span class="o">.</span><span class="n">__traceback__</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">MLFlowRunHierarchyException</span><span class="p">(</span>
                    <span class="s2">&quot;allow_nesting is False, but loggers are nested!&quot;</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;End the run by calling the underlying ActiveRun&#39;s exit method.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;run_&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Log an output dict to MLFlow.&quot;&quot;&quot;</span>
        <span class="n">mlflow_logger</span><span class="p">(</span><span class="n">output_dict</span><span class="p">)</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">set_tags</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extra_tags</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="matfact.model.logging.MLFlowLoggerArtifact" class="doc doc-heading">
        <code>MLFlowLoggerArtifact</code>


</h3>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><a class="autorefs autorefs-internal" title="matfact.model.logging.MLFlowLogger" href="#matfact.model.logging.MLFlowLogger">MLFlowLogger</a></code></p>

  
      <p>Context manager for MLFlow logging, with artifact logging.</p>
<p>All artifacts in artifact_path will be logged to the MLFlow run.</p>


        <details class="quote">
          <summary>Source code in <code>matfact/model/logging.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">MLFlowLoggerArtifact</span><span class="p">(</span><span class="n">MLFlowLogger</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Context manager for MLFlow logging, with artifact logging.</span>

<span class="sd">    All artifacts in artifact_path will be logged to the MLFlow run.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">artifact_path</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">,</span>
        <span class="n">allow_nesting</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">extra_tags</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">create_artifact_path</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">create_path_default</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">allow_nesting</span><span class="o">=</span><span class="n">allow_nesting</span><span class="p">,</span> <span class="n">extra_tags</span><span class="o">=</span><span class="n">extra_tags</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">figure_path</span> <span class="o">=</span> <span class="n">artifact_path</span>
        <span class="k">if</span> <span class="n">create_artifact_path</span><span class="p">:</span>
            <span class="n">artifact_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_dict</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">output_dict</span><span class="p">)</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">log_artifacts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">figure_path</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="matfact.model.logging.MLFlowLoggerDiagnostic" class="doc doc-heading">
        <code>MLFlowLoggerDiagnostic</code>


</h3>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><a class="autorefs autorefs-internal" title="matfact.model.logging.MLFlowLoggerArtifact" href="#matfact.model.logging.MLFlowLoggerArtifact">MLFlowLoggerArtifact</a></code></p>

  
      <p>Context manager for MLFlow logging, generating default diagnostic plots.</p>


        <details class="quote">
          <summary>Source code in <code>matfact/model/logging.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">MLFlowLoggerDiagnostic</span><span class="p">(</span><span class="n">MLFlowLoggerArtifact</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Context manager for MLFlow logging, generating default diagnostic plots.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_dict</span><span class="p">):</span>
        <span class="n">solver_output</span> <span class="o">=</span> <span class="n">output_dict</span><span class="p">[</span><span class="s2">&quot;meta&quot;</span><span class="p">][</span><span class="s2">&quot;results&quot;</span><span class="p">]</span>
        <span class="n">plot_coefs</span><span class="p">(</span><span class="n">solver_output</span><span class="p">[</span><span class="s2">&quot;U&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">figure_path</span><span class="p">)</span>
        <span class="n">plot_basis</span><span class="p">(</span><span class="n">solver_output</span><span class="p">[</span><span class="s2">&quot;V&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">figure_path</span><span class="p">)</span>
        <span class="n">number_of_states</span> <span class="o">=</span> <span class="n">solver_output</span><span class="p">[</span><span class="s2">&quot;p_pred&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">plot_confusion</span><span class="p">(</span>
            <span class="n">solver_output</span><span class="p">[</span><span class="s2">&quot;x_true&quot;</span><span class="p">],</span>
            <span class="n">solver_output</span><span class="p">[</span><span class="s2">&quot;x_pred&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">figure_path</span><span class="p">,</span>
            <span class="n">n_classes</span><span class="o">=</span><span class="n">number_of_states</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">plot_roc_curve</span><span class="p">(</span>
            <span class="n">solver_output</span><span class="p">[</span><span class="s2">&quot;x_true&quot;</span><span class="p">],</span>
            <span class="n">solver_output</span><span class="p">[</span><span class="s2">&quot;p_pred&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">figure_path</span><span class="p">,</span>
            <span class="n">number_of_states</span><span class="o">=</span><span class="n">number_of_states</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">plot_certainty</span><span class="p">(</span>
            <span class="n">solver_output</span><span class="p">[</span><span class="s2">&quot;p_pred&quot;</span><span class="p">],</span> <span class="n">solver_output</span><span class="p">[</span><span class="s2">&quot;x_true&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">figure_path</span>
        <span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">output_dict</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="matfact.model.logging.batch_mlflow_logger" class="doc doc-heading">
<code class="highlight language-python"><span class="n">batch_mlflow_logger</span><span class="p">(</span><span class="n">log_data</span><span class="p">,</span> <span class="n">aggregate_funcs</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Combine and log a set of runs.</p>
<p>Used in for example cross validation training, where all folds should be logged
as one run.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>log_data</code></td>
          <td>
                <code>list[dict]</code>
          </td>
          <td><p>list of run data. Each entry in log_data should be compatible with the
format expected by <code>_mlflow_logger</code>.
<div class="highlight"><pre><span></span><code><span class="p">{</span>
    <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;field1&quot;</span><span class="p">:</span> <span class="n">value1</span><span class="p">,},</span>
    <span class="s2">&quot;metrics&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;field2&quot;</span><span class="p">:</span> <span class="n">foo</span><span class="p">,</span> <span class="s2">&quot;field_history&quot;</span><span class="p">:</span> <span class="p">[</span><span class="o">...</span><span class="p">],},</span>
    <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="p">{},</span>
<span class="p">}</span>
</code></pre></div></p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>matfact/model/logging.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">batch_mlflow_logger</span><span class="p">(</span>
    <span class="n">log_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">aggregate_funcs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">AggregationFunction</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Combine and log a set of runs.</span>

<span class="sd">    Used in for example cross validation training, where all folds should be logged</span>
<span class="sd">    as one run.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        log_data: list of run data. Each entry in log_data should be compatible with the</span>
<span class="sd">            format expected by `_mlflow_logger`.</span>
<span class="sd">            ```python</span>
<span class="sd">            {</span>
<span class="sd">                &quot;params&quot;: {&quot;field1&quot;: value1,},</span>
<span class="sd">                &quot;metrics&quot;: {&quot;field2&quot;: foo, &quot;field_history&quot;: [...],},</span>
<span class="sd">                &quot;tags&quot;: {},</span>
<span class="sd">            }</span>
<span class="sd">            ```</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">new_log</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s2">&quot;metrics&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="p">{},</span>
    <span class="p">}</span>

    <span class="n">new_log</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_aggregate_fields</span><span class="p">(</span>
        <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">log_data</span><span class="p">],</span> <span class="n">aggregate_funcs</span><span class="o">=</span><span class="n">aggregate_funcs</span>
    <span class="p">)</span>
    <span class="n">new_log</span><span class="p">[</span><span class="s2">&quot;metrics&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_aggregate_fields</span><span class="p">(</span>
        <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;metrics&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">log_data</span><span class="p">],</span> <span class="n">aggregate_funcs</span><span class="o">=</span><span class="n">aggregate_funcs</span>
    <span class="p">)</span>

    <span class="n">mlflow_logger</span><span class="p">(</span><span class="n">new_log</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="matfact.model.logging.mlflow_logger" class="doc doc-heading">
<code class="highlight language-python"><span class="n">mlflow_logger</span><span class="p">(</span><span class="n">log_data</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Log results dictionary to MLFlow.</p>
<p>Given a dictionary on the format below, add the run to mlflow.
Assumes there to be an active MLFlow run!
The run is typically started by
<a class="autorefs autorefs-internal" href="#matfact.model.logging.MLFlowLogger"><code>MLFLowLogger</code></a>.</p>
<p>Params and metrics should have values that are floats.
Metric also accepts a list of floats, in which case they are interpreted as
the metric value as a function of the epochs.
<div class="highlight"><pre><span></span><code><span class="p">{</span>
    <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;param1&quot;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span> <span class="s2">&quot;param2&quot;</span><span class="p">:</span> <span class="n">value</span><span class="p">,},</span>
    <span class="s2">&quot;metrics&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;metric1&quot;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span> <span class="s2">&quot;metric2&quot;</span><span class="p">:</span> <span class="p">[</span><span class="o">...</span><span class="p">]},</span>
    <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="p">{},</span>
    <span class="s2">&quot;meta&quot;</span><span class="p">:</span> <span class="p">{},</span>  <span class="c1"># Data not logged to MLFLow</span>
<span class="p">}</span>
</code></pre></div></p>

      <details class="quote">
        <summary>Source code in <code>matfact/model/logging.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">mlflow_logger</span><span class="p">(</span><span class="n">log_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Log results dictionary to MLFlow.</span>

<span class="sd">    Given a dictionary on the format below, add the run to mlflow.</span>
<span class="sd">    Assumes there to be an active MLFlow run!</span>
<span class="sd">    The run is typically started by</span>
<span class="sd">    [`MLFLowLogger`][matfact.model.logging.MLFlowLogger].</span>

<span class="sd">    Params and metrics should have values that are floats.</span>
<span class="sd">    Metric also accepts a list of floats, in which case they are interpreted as</span>
<span class="sd">    the metric value as a function of the epochs.</span>
<span class="sd">    ```python</span>
<span class="sd">    {</span>
<span class="sd">        &quot;params&quot;: {&quot;param1&quot;: value, &quot;param2&quot;: value,},</span>
<span class="sd">        &quot;metrics&quot;: {&quot;metric1&quot;: value, &quot;metric2&quot;: [...]},</span>
<span class="sd">        &quot;tags&quot;: {},</span>
<span class="sd">        &quot;meta&quot;: {},  # Data not logged to MLFLow</span>
<span class="sd">    }</span>
<span class="sd">    ```</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">parameter</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">log_data</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="n">parameter</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">log_data</span><span class="p">[</span><span class="s2">&quot;metrics&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">value_at_epoch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">value_at_epoch</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">epoch</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">set_tags</span><span class="p">(</span><span class="n">log_data</span><span class="p">[</span><span class="s2">&quot;tags&quot;</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="matfact.data_generation.Dataset" class="doc doc-heading">
        <code>matfact.data_generation.Dataset</code>


</h2>


  <div class="doc doc-contents first">

  
      <p>Screening dataset container</p>
<p>This class simplifies generating, loading, and saving datasets.</p>
<div class="admonition note">
<p class="admonition-title">Chaining</p>
<p>Most methods returns the Dataset object, so that it is chainable, as
<div class="highlight"><pre><span></span><code><span class="n">Dataset</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">some_path</span><span class="p">)</span><span class="o">.</span><span class="n">get_X_M</span><span class="p">()</span>
</code></pre></div></p>
</div>


        <details class="quote">
          <summary>Source code in <code>matfact/data_generation/dataset.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Dataset</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Screening dataset container</span>

<span class="sd">    This class simplifies generating, loading, and saving datasets.</span>

<span class="sd">    !!! Note &quot;Chaining&quot;</span>

<span class="sd">        Most methods returns the Dataset object, so that it is chainable, as</span>
<span class="sd">        ```python</span>
<span class="sd">        Dataset.from_file(some_path).get_X_M()</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">M</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">metadata</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">X</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">M</span> <span class="o">=</span> <span class="n">M</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="s2">&quot;Dataset object of size&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> with rank&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> and sparsity level&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;sparsity_level&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load dataset from file&quot;&quot;&quot;</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;X.npy&quot;</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;M.npy&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;dataset_metadata.json&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">metadata_file</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">metadata_file</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Store dataset to file&quot;&quot;&quot;</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;X.npy&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;M.npy&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>
        <span class="k">with</span> <span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;dataset_metadata.json&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">metadata_file</span><span class="p">:</span>
            <span class="n">metadata_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">generate</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">N</span><span class="p">,</span>
        <span class="n">T</span><span class="p">,</span>
        <span class="n">rank</span><span class="p">,</span>
        <span class="n">sparsity_level</span><span class="p">,</span>
        <span class="n">produce_dataset_function</span><span class="o">=</span><span class="n">produce_dataset</span><span class="p">,</span>
        <span class="n">number_of_states</span><span class="o">=</span><span class="n">default_number_of_states</span><span class="p">,</span>
        <span class="n">observation_probabilities</span><span class="o">=</span><span class="n">default_observation_probabilities</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate a Dataset</span>

<span class="sd">        produce_dataset_function should be a callable with signature</span>
<span class="sd">        ```</span>
<span class="sd">        Callable(</span>
<span class="sd">            N, T, rank, sparsity_level, *, number_of_states, observation_probabilities</span>
<span class="sd">        ) -&gt; observed_matrix: ndarray, latent_matrix: ndarray, generation_name: str</span>
<span class="sd">        ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">generation_name</span> <span class="o">=</span> <span class="n">produce_dataset_function</span><span class="p">(</span>
            <span class="n">N</span><span class="p">,</span>
            <span class="n">T</span><span class="p">,</span>
            <span class="n">rank</span><span class="p">,</span>
            <span class="n">sparsity_level</span><span class="p">,</span>
            <span class="n">number_of_states</span><span class="o">=</span><span class="n">number_of_states</span><span class="p">,</span>
            <span class="n">observation_probabilities</span><span class="o">=</span><span class="n">observation_probabilities</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">number_of_individuals</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">number_of_individuals</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Data generation produced no valid screening data!&quot;</span><span class="p">)</span>

        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;rank&quot;</span><span class="p">:</span> <span class="n">rank</span><span class="p">,</span>
            <span class="s2">&quot;sparsity_level&quot;</span><span class="p">:</span> <span class="n">sparsity_level</span><span class="p">,</span>
            <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="n">N</span><span class="p">,</span>
            <span class="s2">&quot;T&quot;</span><span class="p">:</span> <span class="n">T</span><span class="p">,</span>
            <span class="s2">&quot;generation_method&quot;</span><span class="p">:</span> <span class="n">generation_name</span><span class="p">,</span>
            <span class="s2">&quot;number_of_states&quot;</span><span class="p">:</span> <span class="n">number_of_states</span><span class="p">,</span>
            <span class="s2">&quot;observation_probabilities&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">observation_probabilities</span><span class="p">),</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_X_M</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the X and M matrix.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span>

    <span class="k">def</span> <span class="nf">get_split_X_M</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ratio</span><span class="o">=</span><span class="mf">0.8</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Split dataset into train and test subsets.&quot;&quot;&quot;</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">M</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_X_M</span><span class="p">()</span>
        <span class="n">slice_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">ratio</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">X</span><span class="p">[:</span><span class="n">slice_index</span><span class="p">],</span> <span class="n">X</span><span class="p">[</span><span class="n">slice_index</span><span class="p">:],</span> <span class="n">M</span><span class="p">[:</span><span class="n">slice_index</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">slice_index</span><span class="p">:]</span>

    <span class="k">def</span> <span class="nf">prefixed_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;DATASET_&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the metadata dict with prefix prepended to keys</span>

<span class="sd">        Convenience method used in for example logging&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="matfact.data_generation.dataset.Dataset.from_file" class="doc doc-heading">
<code class="highlight language-python"><span class="n">from_file</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  
      <p>Load dataset from file</p>

      <details class="quote">
        <summary>Source code in <code>matfact/data_generation/dataset.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">from_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Load dataset from file&quot;&quot;&quot;</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;X.npy&quot;</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;M.npy&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;dataset_metadata.json&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">metadata_file</span><span class="p">:</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">metadata_file</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="matfact.data_generation.dataset.Dataset.generate" class="doc doc-heading">
<code class="highlight language-python"><span class="n">generate</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">sparsity_level</span><span class="p">,</span> <span class="n">produce_dataset_function</span><span class="o">=</span><span class="n">produce_dataset</span><span class="p">,</span> <span class="n">number_of_states</span><span class="o">=</span><span class="n">default_number_of_states</span><span class="p">,</span> <span class="n">observation_probabilities</span><span class="o">=</span><span class="n">default_observation_probabilities</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  
      <p>Generate a Dataset</p>
<p>produce_dataset_function should be a callable with signature
<div class="highlight"><pre><span></span><code>Callable(
    N, T, rank, sparsity_level, *, number_of_states, observation_probabilities
) -&gt; observed_matrix: ndarray, latent_matrix: ndarray, generation_name: str
</code></pre></div></p>

      <details class="quote">
        <summary>Source code in <code>matfact/data_generation/dataset.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">generate</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span>
    <span class="n">N</span><span class="p">,</span>
    <span class="n">T</span><span class="p">,</span>
    <span class="n">rank</span><span class="p">,</span>
    <span class="n">sparsity_level</span><span class="p">,</span>
    <span class="n">produce_dataset_function</span><span class="o">=</span><span class="n">produce_dataset</span><span class="p">,</span>
    <span class="n">number_of_states</span><span class="o">=</span><span class="n">default_number_of_states</span><span class="p">,</span>
    <span class="n">observation_probabilities</span><span class="o">=</span><span class="n">default_observation_probabilities</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate a Dataset</span>

<span class="sd">    produce_dataset_function should be a callable with signature</span>
<span class="sd">    ```</span>
<span class="sd">    Callable(</span>
<span class="sd">        N, T, rank, sparsity_level, *, number_of_states, observation_probabilities</span>
<span class="sd">    ) -&gt; observed_matrix: ndarray, latent_matrix: ndarray, generation_name: str</span>
<span class="sd">    ```</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">generation_name</span> <span class="o">=</span> <span class="n">produce_dataset_function</span><span class="p">(</span>
        <span class="n">N</span><span class="p">,</span>
        <span class="n">T</span><span class="p">,</span>
        <span class="n">rank</span><span class="p">,</span>
        <span class="n">sparsity_level</span><span class="p">,</span>
        <span class="n">number_of_states</span><span class="o">=</span><span class="n">number_of_states</span><span class="p">,</span>
        <span class="n">observation_probabilities</span><span class="o">=</span><span class="n">observation_probabilities</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">number_of_individuals</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">number_of_individuals</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Data generation produced no valid screening data!&quot;</span><span class="p">)</span>

    <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;rank&quot;</span><span class="p">:</span> <span class="n">rank</span><span class="p">,</span>
        <span class="s2">&quot;sparsity_level&quot;</span><span class="p">:</span> <span class="n">sparsity_level</span><span class="p">,</span>
        <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="n">N</span><span class="p">,</span>
        <span class="s2">&quot;T&quot;</span><span class="p">:</span> <span class="n">T</span><span class="p">,</span>
        <span class="s2">&quot;generation_method&quot;</span><span class="p">:</span> <span class="n">generation_name</span><span class="p">,</span>
        <span class="s2">&quot;number_of_states&quot;</span><span class="p">:</span> <span class="n">number_of_states</span><span class="p">,</span>
        <span class="s2">&quot;observation_probabilities&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">observation_probabilities</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="matfact.data_generation.dataset.Dataset.get_X_M" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_X_M</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Return the X and M matrix.</p>

      <details class="quote">
        <summary>Source code in <code>matfact/data_generation/dataset.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_X_M</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the X and M matrix.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="matfact.data_generation.dataset.Dataset.get_split_X_M" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_split_X_M</span><span class="p">(</span><span class="n">ratio</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Split dataset into train and test subsets.</p>

      <details class="quote">
        <summary>Source code in <code>matfact/data_generation/dataset.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_split_X_M</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ratio</span><span class="o">=</span><span class="mf">0.8</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Split dataset into train and test subsets.&quot;&quot;&quot;</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">M</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_X_M</span><span class="p">()</span>
    <span class="n">slice_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">ratio</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">X</span><span class="p">[:</span><span class="n">slice_index</span><span class="p">],</span> <span class="n">X</span><span class="p">[</span><span class="n">slice_index</span><span class="p">:],</span> <span class="n">M</span><span class="p">[:</span><span class="n">slice_index</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">slice_index</span><span class="p">:]</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="matfact.data_generation.dataset.Dataset.prefixed_metadata" class="doc doc-heading">
<code class="highlight language-python"><span class="n">prefixed_metadata</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;DATASET_&#39;</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Return the metadata dict with prefix prepended to keys</p>
<p>Convenience method used in for example logging</p>

      <details class="quote">
        <summary>Source code in <code>matfact/data_generation/dataset.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">prefixed_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;DATASET_&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the metadata dict with prefix prepended to keys</span>

<span class="sd">    Convenience method used in for example logging&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="matfact.data_generation.dataset.Dataset.save" class="doc doc-heading">
<code class="highlight language-python"><span class="n">save</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Store dataset to file</p>

      <details class="quote">
        <summary>Source code in <code>matfact/data_generation/dataset.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Store dataset to file&quot;&quot;&quot;</span>
    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;X.npy&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;M.npy&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>
    <span class="k">with</span> <span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;dataset_metadata.json&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">metadata_file</span><span class="p">:</span>
        <span class="n">metadata_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">))</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">


<a id="matfact.model.predict.dataset_utils"></a>
  <div class="doc doc-contents first">
  
      <p>Utility functions for masking prediction data used in training.</p>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="matfact.model.predict.dataset_utils.prediction_data" class="doc doc-heading">
<code class="highlight language-python"><span class="n">prediction_data</span><span class="p">(</span><span class="n">observation_matrix</span><span class="p">,</span> <span class="n">prediction_time_strategy</span><span class="o">=</span><span class="n">_last_observed_time</span><span class="p">,</span> <span class="n">row_masking_strategy</span><span class="o">=</span><span class="n">_mask_row</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Mask observed data to produce test data for predictions.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>prediction_time_strategy</code></td>
          <td>
                <code><span title="collections.abc.Callable">Callable</span>[[<span title="numpy.typing">npt</span>.<span title="numpy.typing.NDArray">NDArray</span>], <span title="numpy.typing">npt</span>.<span title="numpy.typing.NDArray">NDArray</span>]</code>
          </td>
          <td><p>Callable returning prediction times given the
observation_matrix. Defaults to choosing the last observation.</p></td>
          <td>
                <code>_last_observed_time</code>
          </td>
        </tr>
        <tr>
          <td><code>row_masking_strategy</code></td>
          <td>
                <code><span title="collections.abc.Callable">Callable</span>[[<span title="numpy.typing">npt</span>.<span title="numpy.typing.NDArray">NDArray</span>, int], None]</code>
          </td>
          <td><p>Callable masking an observation row,
i.e. individual history, given a time point. Note that the masking is done
in place, not by return.
Defaults to masking the three time slots from prediction time and back.</p></td>
          <td>
                <code>_mask_row</code>
          </td>
        </tr>
    </tbody>
  </table>

<p><strong>Examples:</strong></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">masked_observation</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span> <span class="n">correct_values</span> <span class="o">=</span> <span class="n">prediction_data</span><span class="p">(</span><span class="n">my_data</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">my_data</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">times</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">times</span><span class="p">]</span> <span class="o">==</span> <span class="n">correct_values</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="p">(</span><span class="n">masked_observation</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">times</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">times</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="go">True</span>
</code></pre></div>

      <details class="quote">
        <summary>Source code in <code>matfact/model/predict/dataset_utils.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">prediction_data</span><span class="p">(</span>
    <span class="n">observation_matrix</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">,</span>
    <span class="n">prediction_time_strategy</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span>
        <span class="p">[</span><span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">],</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span>
    <span class="p">]</span> <span class="o">=</span> <span class="n">_last_observed_time</span><span class="p">,</span>
    <span class="n">row_masking_strategy</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="n">_mask_row</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Mask observed data to produce test data for predictions.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        prediction_time_strategy: Callable returning prediction times given the</span>
<span class="sd">            observation_matrix. Defaults to choosing the last observation.</span>
<span class="sd">        row_masking_strategy: Callable masking an observation row,</span>
<span class="sd">            i.e. individual history, given a time point. Note that the masking is done</span>
<span class="sd">            in place, not by return.</span>
<span class="sd">            Defaults to masking the three time slots from prediction time and back.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; masked_observation, times, correct_values = prediction_data(my_data)</span>
<span class="sd">        &gt;&gt;&gt; my_data[range(times.size), times] == correct_values</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; (masked_observation[range(times.size), times] == 0).all()</span>
<span class="sd">        True</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">times</span> <span class="o">=</span> <span class="n">prediction_time_strategy</span><span class="p">(</span><span class="n">observation_matrix</span><span class="p">)</span>
    <span class="c1"># Choose the value at times for each row</span>
    <span class="n">correct_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take_along_axis</span><span class="p">(</span>
        <span class="n">observation_matrix</span><span class="p">,</span> <span class="n">times</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="c1"># row_masking_strategy masks in-place, so important to copy!</span>
    <span class="n">masked_observation_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">observation_matrix</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">masked_observation_matrix</span><span class="p">):</span>
        <span class="n">row_masking_strategy</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">times</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">masked_observation_matrix</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span> <span class="n">correct_values</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">


<a id="matfact.model.predict.classification_tree"></a>
  <div class="doc doc-contents first">
  
      <p>Threshold based classification.</p>
<p>To correct for the data being skewed, we introduce some threshold values that
favor less likely classes, even when they do not have the highest probability.
Consider we have some probabilities [p0, p1, p2], where pi is the probability of
class i. We introduce thresholds [t1, t2], such that instead of choosing the class
with the highest probability, we choose the class as follows: beginning from the class
with the highest number (assumed to be the rearest), check if p2 &gt; t2. If so, we set
the class to p2. Next, check p1 &gt; t1, etc.</p>
<p>In general, given probabilities [p0, p1, p2, ...] and thresholds [t1, t2, ...], set the
class to max(i) where pi &gt; ti.</p>
<p>This prediction algorithm is implemented in <code>ClassificationTree</code>. In addition,
<code>estimate_probability_thresholds</code> estimates the optimal values of the thresholds.</p>

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="matfact.model.predict.classification_tree.ClassificationTree" class="doc doc-heading">
        <code>ClassificationTree</code>


</h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="sklearn.base.BaseEstimator">BaseEstimator</span></code>, <code><span title="sklearn.base.ClassifierMixin">ClassifierMixin</span></code></p>

  
      <p>Perform hierarchical classification given probability thresholds.</p>
<p>Class labels are 1 indexed integers.
The number of thresholds (tau) is one less than the number of classes.</p>


        <details class="quote">
          <summary>Source code in <code>matfact/model/predict/classification_tree.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">ClassificationTree</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">ClassifierMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Perform hierarchical classification given probability thresholds.</span>

<span class="sd">    Class labels are 1 indexed integers.</span>
<span class="sd">    The number of thresholds (tau) is one less than the number of classes.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thresholds</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span> <span class="o">=</span> <span class="n">thresholds</span> <span class="k">if</span> <span class="n">thresholds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probabilities</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Perform classification given probabilities for classes.</span>

<span class="sd">        Arguments:</span>
<span class="sd">        probabilities: (number_of_samples x number_of_classes) ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">number_of_samples</span><span class="p">,</span> <span class="n">number_of_classes</span> <span class="o">=</span> <span class="n">probabilities</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="n">number_of_classes</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Probabilities for </span><span class="si">{</span><span class="n">number_of_classes</span><span class="si">}</span><span class="s2"> classes given. &quot;</span>
                <span class="s2">&quot;The number of thresholds should be one less than the number of classes&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;, but it is </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Set all samples to class one.</span>
        <span class="c1"># Iterate through the classes, if the probability is above the</span>
        <span class="c1"># threshold, assign that class.</span>
        <span class="n">classes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">number_of_samples</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">threshold</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span><span class="p">):</span>
            <span class="c1"># Threshold i correspond to class i + 1, so add one</span>
            <span class="n">classes</span><span class="p">[</span><span class="n">probabilities</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">classes</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Do nothing, fit required by sklearn API specification.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="matfact.model.predict.classification_tree.ClassificationTree.fit" class="doc doc-heading">
<code class="highlight language-python"><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Do nothing, fit required by sklearn API specification.</p>

      <details class="quote">
        <summary>Source code in <code>matfact/model/predict/classification_tree.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Do nothing, fit required by sklearn API specification.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="matfact.model.predict.classification_tree.ClassificationTree.predict" class="doc doc-heading">
<code class="highlight language-python"><span class="n">predict</span><span class="p">(</span><span class="n">probabilities</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Perform classification given probabilities for classes.</p>
      <p>probabilities: (number_of_samples x number_of_classes) ndarray</p>

      <details class="quote">
        <summary>Source code in <code>matfact/model/predict/classification_tree.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probabilities</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Perform classification given probabilities for classes.</span>

<span class="sd">    Arguments:</span>
<span class="sd">    probabilities: (number_of_samples x number_of_classes) ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">number_of_samples</span><span class="p">,</span> <span class="n">number_of_classes</span> <span class="o">=</span> <span class="n">probabilities</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">number_of_classes</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Probabilities for </span><span class="si">{</span><span class="n">number_of_classes</span><span class="si">}</span><span class="s2"> classes given. &quot;</span>
            <span class="s2">&quot;The number of thresholds should be one less than the number of classes&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;, but it is </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Set all samples to class one.</span>
    <span class="c1"># Iterate through the classes, if the probability is above the</span>
    <span class="c1"># threshold, assign that class.</span>
    <span class="n">classes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">number_of_samples</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">threshold</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span><span class="p">):</span>
        <span class="c1"># Threshold i correspond to class i + 1, so add one</span>
        <span class="n">classes</span><span class="p">[</span><span class="n">probabilities</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">classes</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="matfact.model.predict.classification_tree.estimate_probability_thresholds" class="doc doc-heading">
<code class="highlight language-python"><span class="n">estimate_probability_thresholds</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_predicted_probabilities</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-06</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Estimate threshold values for ClassificationTree with differential evolution.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>y_true</code></td>
          <td>
                <code><span title="numpy">np</span>.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>Vector of class labels.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>y_pred_proba</code></td>
          <td>
          </td>
          <td><p>Vector of predicted probabilities.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td><p>A ClassificationTree object instantiated with the estimated probability</p></td>
        </tr>
        <tr>
          <td>
          </td>
          <td><p>thresholds. This object may be saved to disk using scikit-learn routines.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>matfact/model/predict/classification_tree.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">estimate_probability_thresholds</span><span class="p">(</span>
    <span class="n">y_true</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">y_predicted_probabilities</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">tol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-6</span><span class="p">,</span>
    <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Estimate threshold values for ClassificationTree with differential evolution.</span>

<span class="sd">    Args:</span>
<span class="sd">        y_true: Vector of class labels.</span>
<span class="sd">        y_pred_proba: Vector of predicted probabilities.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A ClassificationTree object instantiated with the estimated probability</span>
<span class="sd">        thresholds. This object may be saved to disk using scikit-learn routines.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">check_X_y</span><span class="p">(</span><span class="n">y_predicted_probabilities</span><span class="p">,</span> <span class="n">y_true</span><span class="p">)</span>
    <span class="n">number_of_classes</span> <span class="o">=</span> <span class="n">y_predicted_probabilities</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">differential_evolution</span><span class="p">(</span>
        <span class="n">_matthews_correlation_coefficient_objective</span><span class="p">,</span>
        <span class="c1"># Bounds are [0, 1] for each threshold value, i.e. one less than the number</span>
        <span class="c1"># of classes. Iterators are not accepted, so convert to list.</span>
        <span class="n">bounds</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">number_of_classes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)),</span>
        <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_predicted_probabilities</span><span class="p">,</span> <span class="n">ClassificationTree</span><span class="p">()),</span>
        <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span>
        <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">ClassificationTree</span><span class="p">(</span><span class="n">thresholds</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../usage/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Usage" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Usage
            </div>
          </div>
        </a>
      
      
        
        <a href="../hmm/" class="md-footer__link md-footer__link--next" aria-label="Next: HMM" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              HMM
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": ["content.code.annotate"], "search": "../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.d6c3db9e.min.js"></script>
      
        <script src="../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>